<?xml version="1.0" encoding="utf-8"?>
<search> 
  
    
    <entry>
      <title>mysql配置文件示例</title>
      <link href="/2018/12/18/mysql%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E7%A4%BA%E4%BE%8B/"/>
      <url>/2018/12/18/mysql%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E7%A4%BA%E4%BE%8B/</url>
      
        <content type="html"><![CDATA[<h1 id="配置文件名称my-cnf"><a href="#配置文件名称my-cnf" class="headerlink" title="配置文件名称my.cnf"></a>配置文件名称my.cnf</h1><blockquote><p>文件目录:一般为/etc/my.cnf</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line"># MySQL configuration is created by yanghang</span><br><span class="line">[client]</span><br><span class="line">port = 3306</span><br><span class="line">socket = /tmp/mysql.sock</span><br><span class="line">user=root</span><br><span class="line">password=123456</span><br><span class="line">#The MySQL server</span><br><span class="line">###############Basic###############</span><br><span class="line">[mysqld]</span><br><span class="line">server-id=71</span><br><span class="line">report-host=192.168.2.71</span><br><span class="line">port = 3306</span><br><span class="line">user = mysql</span><br><span class="line">#禁止域名解析</span><br><span class="line">skip-name-resolve</span><br><span class="line">skip-external-locking</span><br><span class="line">#数据目录</span><br><span class="line">basedir=/data/mysql</span><br><span class="line">datadir=/data/mysql/data</span><br><span class="line">socket=/tmp/mysql.sock</span><br><span class="line">#服务端默认编码</span><br><span class="line">character_set_server = utf8</span><br><span class="line">#服务端默认的对比规则，排序规则</span><br><span class="line">collation_server=utf8_general_ci</span><br><span class="line">#slave库需要设置</span><br><span class="line">#read_only=1</span><br><span class="line">#超时时间</span><br><span class="line">wait_timeout=100</span><br><span class="line">interactive_timeout=100</span><br><span class="line">#事件开关</span><br><span class="line">event_scheduler = OFF</span><br><span class="line">###############binlog###############</span><br><span class="line">#不强制限制存储函数创建,这个变量也适用于触发器创建</span><br><span class="line">log_bin_trust_function_creators = 1</span><br><span class="line">#binlog存储地址</span><br><span class="line">log_bin = /data/mysql/logs/binlog/mysql-bin</span><br><span class="line">#binlog格式</span><br><span class="line">binlog_format = row</span><br><span class="line">#binlog过期时间</span><br><span class="line">expire-logs-days = 7</span><br><span class="line">#binlog缓存日志</span><br><span class="line">binlog_cache_size = 2M</span><br><span class="line">#控制数据库的binlog是否刷新到磁盘，高并发的环境开启对IO影响很大</span><br><span class="line">#sync_binlog = 1</span><br><span class="line"></span><br><span class="line">###主主复制时使用###修改将主从的offset分别设成1和2</span><br><span class="line">#自增初始值</span><br><span class="line">#auto_increment_offset = 1</span><br><span class="line">#自增间隔</span><br><span class="line">#auto_increment_increment = 2</span><br><span class="line"></span><br><span class="line">###############log_error###############</span><br><span class="line">#错误日志配置</span><br><span class="line">log_error = /data/mysql/logs/mysql-error.log</span><br><span class="line">###############slow log###############</span><br><span class="line">slow_query_log = 1</span><br><span class="line">slow_query_log_file = /data/mysql/logs/mysql-slow.log</span><br><span class="line">long_query_time = 5</span><br><span class="line">###############relay日志#############</span><br><span class="line">relay_log = /data/mysql/logs/relay/mysql-relay-bin.log</span><br><span class="line">relay_log_info_file = /data/mysql/logs/relay/mysql-relay-log.info</span><br><span class="line">relay_log_purge=0</span><br><span class="line"></span><br><span class="line">###############半同步复制#############</span><br><span class="line">#plugin-load = &quot;rpl_semi_sync_master=semisync_master.so;rpl_semi_sync_slave=semisync_slave.so&quot;</span><br><span class="line">#rpl-semi-sync-master-enabled = 1</span><br><span class="line">#rpl-semi-sync-slave-enabled = 1</span><br><span class="line">#rpl_semi_sync_master_wait_no_slave = 1</span><br><span class="line">#rpl_semi_sync_master_timeout = 1000</span><br><span class="line"></span><br><span class="line">###############innodb#############</span><br><span class="line">#innodb_data_file_path = ibdata1:2G:autoextend</span><br><span class="line">innodb_file_per_table = 1</span><br><span class="line">innodb_open_files = 500</span><br><span class="line">innodb_write_io_threads = 32</span><br><span class="line">innodb_read_io_threads = 32</span><br><span class="line">#一般设置为内存的80%</span><br><span class="line">innodb_buffer_pool_size = 1G</span><br><span class="line">innodb_file_per_table = 1</span><br><span class="line">#生产环境可以设置为1024M</span><br><span class="line">innodb_log_file_size = 50M</span><br><span class="line">innodb_log_buffer_size = 64M</span><br><span class="line">innodb_log_files_in_group = 3</span><br><span class="line">innodb_file_format = Barracuda</span><br><span class="line">innodb_flush_log_at_trx_commit = 2</span><br><span class="line">innodb_buffer_pool_instances = 8</span><br><span class="line">#5.6.42报已InnoDB: Warning: Using innodb_additional_mem_pool_size is DEPRECATED. This option may be removed in future releases, together with the option innodb_use_sys_malloc and with the InnoDB&apos;s internal memory allocator.</span><br><span class="line">#innodb_additional_mem_pool_size = 16M</span><br><span class="line">innodb_lock_wait_timeout = 10</span><br><span class="line">innodb_flush_method = O_DIRECT</span><br><span class="line">innodb_change_buffering = all</span><br><span class="line">innodb_purge_threads = 1</span><br><span class="line">innodb_purge_batch_size = 32</span><br><span class="line">transaction_isolation = READ-COMMITTED</span><br><span class="line">###############per_thread_buffers#############</span><br><span class="line">max_connections = 1024</span><br><span class="line">max_user_connections = 1000</span><br><span class="line">max_connect_errors = 10000</span><br><span class="line">lower_case_table_names = 1</span><br><span class="line">key_buffer_size = 64M</span><br><span class="line">table_open_cache = 6144</span><br><span class="line">table_definition_cache = 4096</span><br><span class="line">sort_buffer_size = 512K</span><br><span class="line">read_buffer_size = 512K</span><br><span class="line">join_buffer_size = 512K</span><br><span class="line">tmp_table_size = 64M</span><br><span class="line">max_heap_table_size = 64M</span><br><span class="line">query_cache_type=0</span><br><span class="line">query_cache_size=0</span><br><span class="line">bulk_insert_buffer_size = 32M</span><br><span class="line">thread_cache_size = 64</span><br><span class="line">thread_stack = 256K</span><br><span class="line">max_allowed_packet = 1024M</span><br><span class="line">#mysql5.6和mysql5.7默认的sql_mode不一样</span><br><span class="line">#sql_mode = STRICT_TRANS_TABLES,NO_ENGINE_SUBSTITUTION</span><br><span class="line"></span><br><span class="line">[mysqld_safe]</span><br><span class="line">#若要开启此选项则需要安装jemalloc</span><br><span class="line">#malloc-lib=/usr/lib64/libjemalloc.so.1</span><br><span class="line">open_files_limit = 65535</span><br><span class="line"></span><br><span class="line">[mysqldump]</span><br><span class="line">quick</span><br><span class="line">max_allowed_packet = 1024M</span><br><span class="line">net_buffer_length = 16384</span><br><span class="line">user=root</span><br><span class="line">password=123456</span><br><span class="line">[mysql]</span><br><span class="line">auto-rehash</span><br><span class="line">[mysqlhotcopy]</span><br><span class="line">interactive-timeout</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>mysql常用统计sql</title>
      <link href="/2018/12/18/mysql%E5%B8%B8%E7%94%A8%E7%BB%9F%E8%AE%A1sql/"/>
      <url>/2018/12/18/mysql%E5%B8%B8%E7%94%A8%E7%BB%9F%E8%AE%A1sql/</url>
      
        <content type="html"><![CDATA[<h1 id="概要"><a href="#概要" class="headerlink" title="概要"></a>概要</h1><blockquote><p>系统维护中经常会用到统计mysql数据库中数据量大小的需要，因此今天整理了一下常用的几个mysql统计数据库信息的sql，方便以后使用。mysql5.6中自带的information_schema数据库，此库中装的是mysql的元数据，包括数据库信息、数据库中表的信息等。所以要想查询数据库占用磁盘的空间大小可以通过对information_schema数据库进行操作。</p></blockquote><p>information_schema中的表主要有：</p><ul><li>schemata表：这个表里面主要是存储在mysql中的所有的数据库的信息</li><li>tables表：这个表里存储了所有数据库中的表的信息，包括每个表有多少个列等信息。</li><li>columns表：这个表存储了所有表中的表字段信息。</li><li>statistics表：存储了表中索引的信息。</li><li>user_privileges表：存储了用户的权限信息。</li><li>schema_privileges表：存储了数据库权限。</li><li>table_privileges表：存储了表的权限。</li><li>column_privileges表：存储了列的权限信息。</li><li>character_sets表：存储了mysql可以用的字符集的信息。</li><li>collations表：提供各个字符集的对照信息。</li><li>collation_character_set_applicability表：相当于collations表和character_sets表的前两个字段的一个对比，记录了字符集之间的对照信息。</li><li>table_constraints表：这个表主要是用于记录表的描述存在约束的表和约束类型。</li><li>key_column_usage表：记录具有约束的列。</li><li>routines表：记录了存储过程和函数的信息，不包含自定义的过程或函数信息。</li><li>views表：记录了视图信息，需要有show view权限。</li><li>triggers表：存储了触发器的信息，需要有super权限。</li></ul><h1 id="常用sql"><a href="#常用sql" class="headerlink" title="常用sql"></a>常用sql</h1><h2 id="1-统计mysql中每个库各自占用空间大小，以MB为单位"><a href="#1-统计mysql中每个库各自占用空间大小，以MB为单位" class="headerlink" title="1.统计mysql中每个库各自占用空间大小，以MB为单位"></a>1.统计mysql中每个库各自占用空间大小，以MB为单位</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> TABLE_SCHEMA <span class="keyword">as</span> <span class="string">'数据库名称'</span> , <span class="keyword">concat</span>(<span class="keyword">SUM</span>(data_length) / <span class="number">1024</span> / <span class="number">1024</span>, <span class="string">' MB'</span>) <span class="keyword">AS</span> <span class="string">'数据长度( MB)'</span>  , <span class="keyword">concat</span>(<span class="keyword">SUM</span>(index_length) / <span class="number">1024</span> / <span class="number">1024</span>, <span class="string">'MB'</span>) <span class="keyword">AS</span> <span class="string">'索引长度( MB)'</span>,<span class="keyword">CONCAT</span>((<span class="keyword">SUM</span>(data_length)+<span class="keyword">SUM</span>(index_length))/<span class="number">1024</span>/<span class="number">1024</span>, <span class="string">' MB'</span>) <span class="keyword">as</span> <span class="string">'数据库大小( MB)'</span>  <span class="keyword">FROM</span> information_schema.tables <span class="keyword">GROUP</span> <span class="keyword">BY</span> TABLE_SCHEMA <span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="keyword">SUM</span>(data_length)+<span class="keyword">SUM</span>(index_length) <span class="keyword">DESC</span>;</span><br></pre></td></tr></table></figure><h2 id="2-统计mysql指定库中所有表所占用的DATA-LENGTH和INDEX-LENGTH大小，以MB为单位，并按表占用空间进行排序"><a href="#2-统计mysql指定库中所有表所占用的DATA-LENGTH和INDEX-LENGTH大小，以MB为单位，并按表占用空间进行排序" class="headerlink" title="2.统计mysql指定库中所有表所占用的DATA_LENGTH和INDEX_LENGTH大小，以MB为单位，并按表占用空间进行排序"></a>2.统计mysql指定库中所有表所占用的DATA_LENGTH和INDEX_LENGTH大小，以MB为单位，并按表占用空间进行排序</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> TABLE_NAME <span class="keyword">as</span> <span class="string">'表名称'</span> , <span class="keyword">CONCAT</span>(DATA_LENGTH/<span class="number">1024</span>/<span class="number">1024</span>, <span class="string">' MB'</span>) <span class="keyword">AS</span> <span class="string">'数据长度( MB)'</span>  , <span class="keyword">CONCAT</span>(INDEX_LENGTH/<span class="number">1024</span>/<span class="number">1024</span>, <span class="string">' MB'</span>) <span class="keyword">AS</span> <span class="string">'索引长度( MB)'</span>,<span class="keyword">CONCAT</span>((DATA_LENGTH+INDEX_LENGTH)/<span class="number">1024</span>/<span class="number">1024</span>, <span class="string">' MB'</span>) <span class="keyword">as</span> <span class="string">'表占用空间大小( MB)'</span> <span class="keyword">FROM</span> information_schema.tables <span class="keyword">WHERE</span> TABLE_SCHEMA = <span class="string">'blxx_netmanager'</span> <span class="keyword">GROUP</span> <span class="keyword">BY</span> TABLE_NAME <span class="keyword">ORDER</span> <span class="keyword">BY</span> DATA_LENGTH+INDEX_LENGTH <span class="keyword">DESC</span>;</span><br></pre></td></tr></table></figure><h2 id="3-查询指定库中表占用空间大小"><a href="#3-查询指定库中表占用空间大小" class="headerlink" title="3.查询指定库中表占用空间大小"></a>3.查询指定库中表占用空间大小</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> TABLE_SCHEMA <span class="keyword">AS</span> <span class="string">'数据库名称'</span>, TABLE_NAME <span class="keyword">AS</span> <span class="string">'表名'</span> , <span class="keyword">concat</span>(<span class="keyword">SUM</span>(data_length) / <span class="number">1024</span> / <span class="number">1024</span>, <span class="string">' MB'</span>) <span class="keyword">AS</span> <span class="string">'数据长度( MB)'</span>  , <span class="keyword">concat</span>(<span class="keyword">SUM</span>(index_length) / <span class="number">1024</span> / <span class="number">1024</span>, <span class="string">'MB'</span>) <span class="keyword">AS</span> <span class="string">'索引长度( MB)'</span>,<span class="keyword">CONCAT</span>((<span class="keyword">SUM</span>(data_length)+<span class="keyword">SUM</span>(index_length))/<span class="number">1024</span>/<span class="number">1024</span>, <span class="string">' MB'</span>) <span class="keyword">as</span> <span class="string">'数据库大小( MB)'</span> <span class="keyword">FROM</span> information_schema.tables <span class="keyword">WHERE</span> table_schema = <span class="string">'库名'</span> <span class="keyword">AND</span> TABLE_NAME = <span class="string">'表名'</span>;</span><br></pre></td></tr></table></figure><h2 id="4-数据库占用总空间"><a href="#4-数据库占用总空间" class="headerlink" title="4.数据库占用总空间"></a>4.数据库占用总空间</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">concat</span>(<span class="keyword">sum</span>(DATA_LENGTH/<span class="number">1024</span>/<span class="number">1024</span>)+<span class="keyword">SUM</span>(index_length/<span class="number">1024</span>/<span class="number">1024</span>),<span class="string">' MB'</span>) <span class="keyword">as</span> <span class="string">'数据库占用总空间( MB)'</span> <span class="keyword">from</span> information_schema.tables;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>mysql的版本升级</title>
      <link href="/2018/12/18/mysql%E7%89%88%E6%9C%AC%E5%8D%87%E7%BA%A7/"/>
      <url>/2018/12/18/mysql%E7%89%88%E6%9C%AC%E5%8D%87%E7%BA%A7/</url>
      
        <content type="html"><![CDATA[<h1 id="1-介绍"><a href="#1-介绍" class="headerlink" title="1 介绍"></a>1 介绍</h1><blockquote><p>本文介绍针对于Unix/Linux下二进制mysql的版本升级，</p></blockquote><h1 id="2-背景介绍"><a href="#2-背景介绍" class="headerlink" title="2 背景介绍"></a>2 背景介绍</h1><blockquote><p>目前生产上四台数据库服务器，采用MHA架构，所有节点的mysql为5.6.35，采用编译安装源代码方式进行安装。客户在绿盟漏扫过程中发现一堆高危漏洞，因此需要进行数据库升级。</p></blockquote><h1 id="3-升级方案介绍"><a href="#3-升级方案介绍" class="headerlink" title="3. 升级方案介绍"></a>3. 升级方案介绍</h1><blockquote><p>由于目前是MHA架构，因此计划先将三台slave节点进行升级。然后通过mha的在线切换功能将master节点漂移至备用master节点，再升级最后一台服务器。版本选择：采用直接使用mysql官方编译好的二进制安装包：mysql-5.6.42-linux-glibc2.12-x86_64.tar.gz</p></blockquote><h1 id="4-步骤"><a href="#4-步骤" class="headerlink" title="4 步骤"></a>4 步骤</h1><blockquote><p>升级备机时先检查备机的复制状态。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show slave status\G</span><br></pre></td></tr></table></figure></p></blockquote><h2 id="4-1-停止mysql服务"><a href="#4-1-停止mysql服务" class="headerlink" title="4.1 停止mysql服务"></a>4.1 停止mysql服务</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service mysqld stop</span><br></pre></td></tr></table></figure><h2 id="4-2-删除软连接"><a href="#4-2-删除软连接" class="headerlink" title="4.2 删除软连接"></a>4.2 删除软连接</h2><blockquote><p>做mha的时候配置了两条软连接：/usr/local/bin/mysql /usr/local/bin/mysqlbinlog<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rm -rf /usr/local/bin/mysql</span><br><span class="line">rm -rf /usr/local/bin/mysqlbinlog</span><br></pre></td></tr></table></figure></p></blockquote><h2 id="4-2-解压安装包"><a href="#4-2-解压安装包" class="headerlink" title="4.2 解压安装包"></a>4.2 解压安装包</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tar -zxf mysql-5.6.42-linux-glibc2.12-x86_64.tar.gz -C /data</span><br><span class="line">rm -rf /data/mysql-5.6.42-linux-glibc2.12-x86_64/data</span><br></pre></td></tr></table></figure><h2 id="4-3-备份原数据库安装文件"><a href="#4-3-备份原数据库安装文件" class="headerlink" title="4.3 备份原数据库安装文件"></a>4.3 备份原数据库安装文件</h2><blockquote><p>原数据库目录为：/data/mysql<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mv /data/mysql /data/mysql_backup</span><br></pre></td></tr></table></figure></p></blockquote><h2 id="4-4-做软连接"><a href="#4-4-做软连接" class="headerlink" title="4.4 做软连接"></a>4.4 做软连接</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ln -s /data/mysql-5.6.42-linux-glibc2.12-x86_64 /data/mysql</span><br><span class="line">ln -s /data/mysql/bin/mysql /usr/local/bin/mysql</span><br><span class="line">ln -s /data/mysql/bin/mysqlbinlog /usr/local/bin/mysqlbinlog</span><br></pre></td></tr></table></figure><h2 id="4-5-拷贝数据"><a href="#4-5-拷贝数据" class="headerlink" title="4.5 拷贝数据"></a>4.5 拷贝数据</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mv /data/mysql_backup/data /data/mysql-5.6.42-linux-glibc2.12-x86_64/data</span><br><span class="line">mv /data/mysql_backup/log /data/mysql-5.6.42-linux-glibc2.12-x86_64/log</span><br></pre></td></tr></table></figure><h2 id="4-6-修改权限"><a href="#4-6-修改权限" class="headerlink" title="4.6 修改权限"></a>4.6 修改权限</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chown -R mysql:mysql /data/mysql/</span><br></pre></td></tr></table></figure><h2 id="4-7-启动"><a href="#4-7-启动" class="headerlink" title="4.7 启动"></a>4.7 启动</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service mysqld start</span><br></pre></td></tr></table></figure><h2 id="4-8-执行升级命令"><a href="#4-8-执行升级命令" class="headerlink" title="4.8 执行升级命令"></a>4.8 执行升级命令</h2><blockquote><p>升级日志记录<br><img src="https://i.loli.net/2018/12/14/5c1315457fc66.png" alt="mysql_upgrade.png" title="mysql_upgrade.png"></p></blockquote><h2 id="4-9-重启mysql"><a href="#4-9-重启mysql" class="headerlink" title="4.9 重启mysql"></a>4.9 重启mysql</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service mysqld restart</span><br></pre></td></tr></table></figure><h2 id="4-10-查看主从复制状态"><a href="#4-10-查看主从复制状态" class="headerlink" title="4.10 查看主从复制状态"></a>4.10 查看主从复制状态</h2><h2 id="4-11-至此，slave节点mysql升级完毕"><a href="#4-11-至此，slave节点mysql升级完毕" class="headerlink" title="4.11 至此，slave节点mysql升级完毕"></a>4.11 至此，slave节点mysql升级完毕</h2><h2 id="4-12-将剩余两台也按上述方式进行升级"><a href="#4-12-将剩余两台也按上述方式进行升级" class="headerlink" title="4.12 将剩余两台也按上述方式进行升级"></a>4.12 将剩余两台也按上述方式进行升级</h2><h2 id="4-13-使用mha在线切换功能切换master节点"><a href="#4-13-使用mha在线切换功能切换master节点" class="headerlink" title="4.13 使用mha在线切换功能切换master节点"></a>4.13 使用mha在线切换功能切换master节点</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">masterha_master_switch --conf=/etc/masterha/app1.conf --master_state=alive --new_master_host=blxx-db07 --new_master_port=3306 --orig_master_is_new_slave --running_updates_limit=10000 --interactive=0</span><br></pre></td></tr></table></figure><h2 id="4-14-将之前主节点的mysql进行升级。此次升级完成"><a href="#4-14-将之前主节点的mysql进行升级。此次升级完成" class="headerlink" title="4.14 将之前主节点的mysql进行升级。此次升级完成"></a>4.14 将之前主节点的mysql进行升级。此次升级完成</h2>]]></content>
      
      
      
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>xtrabackup备份使用指南</title>
      <link href="/2018/12/18/xtrabackup%E4%BD%BF%E7%94%A8/"/>
      <url>/2018/12/18/xtrabackup%E4%BD%BF%E7%94%A8/</url>
      
        <content type="html"><![CDATA[<h1 id="1-介绍"><a href="#1-介绍" class="headerlink" title="1 介绍"></a>1 介绍</h1><blockquote><p>本文用来介绍如何使用percona公司的xtrabackup备份工具<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">参考资料：https://www.cnblogs.com/shenxm/p/7862247.html</span><br></pre></td></tr></table></figure></p></blockquote><h1 id="2-安装"><a href="#2-安装" class="headerlink" title="2 安装"></a>2 安装</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum localinstall percona-xtrabackup-24-2.4.11-1.el7.x86_64.rpm -y</span><br></pre></td></tr></table></figure><h1 id="3-使用"><a href="#3-使用" class="headerlink" title="3 使用"></a>3 使用</h1><blockquote><p>由于innobackupex命令既可以备份innodb又可以备份myisam表，因此主要介绍此工具的用法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 备份slave库上的数据。加上此参数会输出master库上的binlog信息</span><br><span class="line">--slave-info</span><br></pre></td></tr></table></figure></p></blockquote><h2 id="3-1-全备备份"><a href="#3-1-全备备份" class="headerlink" title="3.1 全备备份"></a>3.1 全备备份</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">1.全量备份</span><br><span class="line">/usr/bin/innobackupex --defaults-file=/etc/my.cnf --socket=/var/lib/mysql/mysql.sock --host=127.0.0.1 --user=root --password=mvtech123 /data/20181129 --no-timestamp --slave-info --parallel=2 --throttle=800</span><br><span class="line">2.恢复全量备份</span><br><span class="line">    2.1 关闭mysql</span><br><span class="line">    2.2 重命名mysql的数据目录和日志目录</span><br><span class="line">        mv /data/mysql/data /data/mysql/data_20181129</span><br><span class="line">        mv /data/mysql/log /data/mysql/log_20181129</span><br><span class="line">    2.3 应用日志</span><br><span class="line">        innobackupex --apply-log --use-memory=200G  /data/20181129/</span><br><span class="line">    2.4 恢复 注：恢复有两种方式--move-back 和--copy-back，move-back速度快，但备份文件被move后就不存在，请根据实际情况进行选择</span><br><span class="line">        innobackupex --defaults-file=/etc/my.cnf --move-back  /data/20181129/</span><br><span class="line">    2.5 修改权限</span><br><span class="line">        chown -R mysql:mysql /data/mysql</span><br><span class="line">    2.6 启动mysql</span><br><span class="line">        service mysqld start</span><br></pre></td></tr></table></figure><h2 id="3-2-增量备份"><a href="#3-2-增量备份" class="headerlink" title="3.2 增量备份"></a>3.2 增量备份</h2><blockquote><p>增量备份是在全量备份的基础上进行<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">1. 增量备份</span><br><span class="line">    innobackupex --defaults-file=/etc/my.cnf --host=127.0.0.1 --user=root --password=mvtech123 --parallel=4 --throttle=400 --incremental-basedir=/data/20181129  --no-timestamp --slave-info --incremental /data/20181130</span><br><span class="line">2. 恢复</span><br><span class="line">    2.1 关闭mysql</span><br><span class="line">    2.2 重命名mysql的数据目录和日志目录</span><br><span class="line">        mv /data/mysql/data /data/mysql/data_20181129</span><br><span class="line">        mv /data/mysql/log /data/mysql/log_20181129</span><br><span class="line">    2.3 对全量备份做prepare</span><br><span class="line">        innobackupex --apply-log --redo-only /data/20181129</span><br><span class="line">    2.4 对增量备份做prepare </span><br><span class="line">            --redo-only：若只有一个增量备份或是最后那个增量备份文件，那么不需要这个选项，原因同上。也就是说这个选项不能用于最后一个增量备份进行prepare。</span><br><span class="line">            --incremental-dir=：此选项对应的目录为增量备份文件的目录</span><br><span class="line">        innobackupex --apply-log [--redo-only] /data/20181129 --incremental-dir=/data/20181130 </span><br><span class="line">    2.5 查看prepare情况 查看全量备份文件中的xtrabackup_checkpoints</span><br><span class="line">        发现last_lsn = 508150192已经和最后一次备份一致</span><br><span class="line">    2.6 恢复 注：恢复有两种方式--move-back 和--copy-back，move-back速度快，但备份文件被move后就不存在，请根据实际情况进行选择</span><br><span class="line">        innobackupex --defaults-file=/etc/my.cnf --move-back  /data/20181129/</span><br><span class="line">    2.7 修改权限</span><br><span class="line">        chown -R mysql:mysql /data/mysql</span><br><span class="line">    2.8 启动mysql</span><br><span class="line">        service mysqld start</span><br></pre></td></tr></table></figure></p></blockquote><h1 id="附录1-生产全备示例脚本"><a href="#附录1-生产全备示例脚本" class="headerlink" title="附录1 生产全备示例脚本"></a>附录1 生产全备示例脚本</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">#This script is xtrabackup full backup mysql</span><br><span class="line">#The Author is mvtech by 2018</span><br><span class="line"></span><br><span class="line">#格式化日期</span><br><span class="line">today=$(date +%Y%m%d)</span><br><span class="line">deleteDay=`date -d &quot;-1 days&quot; +%Y%m%d`</span><br><span class="line">echo &quot;--------------------------------------------------------&quot;</span><br><span class="line">echo &quot;-------------------Today is $today----------------------&quot;</span><br><span class="line">echo &quot;--------------------Start backup------------------------&quot;</span><br><span class="line">echo &quot;--------------------------------------------------------&quot;</span><br><span class="line">#定义变量</span><br><span class="line">blxxDir=&quot;/data/xtrabackup/$today&quot;</span><br><span class="line">delDir=&quot;/data/xtrabackup/$deleteDay&quot;</span><br><span class="line">#创建备份文件夹</span><br><span class="line">mkdir -p $blxxDir</span><br><span class="line">#全量备份</span><br><span class="line">/usr/bin/innobackupex --defaults-file=/etc/my.cnf --socket=/data/mysql/mysql.sock --host=10.99.0.81 --user=weihu --password=Mvtech123!@ $blxxDir --slave-info --no-timestamp --parallel=8 --throttle=800 </span><br><span class="line">#删除2天以前的备份</span><br><span class="line">rm -rf $delDir</span><br></pre></td></tr></table></figure><h1 id="附录2-备份文件夹里文件说明"><a href="#附录2-备份文件夹里文件说明" class="headerlink" title="附录2 备份文件夹里文件说明"></a>附录2 备份文件夹里文件说明</h1><table><thead><tr><th>序号</th><th>文件名称</th><th>文件用途</th></tr></thead><tbody><tr><td>1</td><td>xtrabackup_binlog_info</td><td>记录导出mysql的binlog信息</td></tr><tr><td>2</td><td>xtrabackup_checkpoints</td><td>记录备份方式</td></tr><tr><td>3</td><td>xtrabackup_info</td><td>记录此次备份的详细信息</td></tr><tr><td>4</td><td>xtrabackup_logfile</td><td>备份的重做日志文件</td></tr><tr><td>5</td><td>xtrabackup_slave_info</td><td>记录备份slave节点时主机上的binlog信息，需要添加–slave-info参数</td></tr></tbody></table>]]></content>
      
      
      
        <tags>
            
            <tag> mysql </tag>
            
            <tag> xtrabackup </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>CDH5.11.2快速配置文档</title>
      <link href="/2018/12/18/CDH5.11.2%E5%BF%AB%E9%80%9F%E9%85%8D%E7%BD%AE%E6%96%87%E6%A1%A3/"/>
      <url>/2018/12/18/CDH5.11.2%E5%BF%AB%E9%80%9F%E9%85%8D%E7%BD%AE%E6%96%87%E6%A1%A3/</url>
      
        <content type="html"><![CDATA[<h1 id="1-概述"><a href="#1-概述" class="headerlink" title="1 概述"></a>1 概述</h1><blockquote><p>本文档用于搭建impala开发测试环境,配置yarn-ha和hdfs-ha</p></blockquote><h1 id="2-服务器规划配置"><a href="#2-服务器规划配置" class="headerlink" title="2 服务器规划配置"></a>2 服务器规划配置</h1><blockquote><p>具体请参考excel文档的部署规划sheet</p></blockquote><center><img src="https://i.loli.net/2018/11/19/5bf264d38a04d.png" alt="东方通impala环境.png" title="东方通impala环境.png"></center><h1 id="3-部署软件版本和下载地址"><a href="#3-部署软件版本和下载地址" class="headerlink" title="3 部署软件版本和下载地址"></a>3 部署软件版本和下载地址</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">mysql5.7.24:</span><br><span class="line">cdh相关软件下载地址：</span><br><span class="line">http://archive.cloudera.com/cm5/cm/5/cloudera-manager-centos7-cm5.11.2_x86_64.tar.gz</span><br><span class="line">http://archive.cloudera.com/cdh5/parcels/5.11.2.4/CDH-5.11.2-1.cdh5.11.2.p0.4-el7.parcel</span><br><span class="line">http://archive.cloudera.com/cdh5/parcels/5.11.2.4/CDH-5.11.2-1.cdh5.11.2.p0.4-el7.parcel.sha1  注：修改文件名称把sha1中的1去掉</span><br><span class="line">http://archive.cloudera.com/cdh5/parcels/5.11.2.4/manifest.json</span><br><span class="line"></span><br><span class="line">jdk-8u144-linux-x64</span><br><span class="line">nginx1.14</span><br><span class="line">ansible</span><br><span class="line">sshpass用法：</span><br><span class="line">sshpass -p &apos;1w98.77B32&apos; ssh -o StrictHostKeyChecking=no root@168.1.2.180 &quot;hostnamectl set-hostname gxjh01&quot;</span><br></pre></td></tr></table></figure><h1 id="4-配置"><a href="#4-配置" class="headerlink" title="4 配置"></a>4 配置</h1><h2 id="4-1-安装配置管理工具ansible"><a href="#4-1-安装配置管理工具ansible" class="headerlink" title="4.1 安装配置管理工具ansible"></a>4.1 安装配置管理工具ansible</h2><blockquote><p>此工具用于批量配置管理服务器</p></blockquote><h3 id="4-1-1-安装"><a href="#4-1-1-安装" class="headerlink" title="4.1.1 安装"></a>4.1.1 安装</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install ansible -y</span><br></pre></td></tr></table></figure><h3 id="4-1-2-修改配置文件"><a href="#4-1-2-修改配置文件" class="headerlink" title="4.1.2 修改配置文件"></a>4.1.2 修改配置文件</h3><blockquote><p>修改/etc/ansible/ansible.cfg，解掉注释<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">host_key_checking = False</span><br></pre></td></tr></table></figure></p></blockquote><h3 id="4-1-3-配置ansible组"><a href="#4-1-3-配置ansible组" class="headerlink" title="4.1.3 配置ansible组"></a>4.1.3 配置ansible组</h3><blockquote><p>编辑/etc/ansible/hosts<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[cdh]</span><br><span class="line">168.1.2.180    ansible_ssh_user=root ansible_ssh_pass=1w98.77B32</span><br><span class="line">168.1.2.181    ansible_ssh_user=root ansible_ssh_pass=1w98.77B32</span><br><span class="line">168.1.2.182    ansible_ssh_user=root ansible_ssh_pass=1w98.77B32</span><br><span class="line">168.1.2.183    ansible_ssh_user=root ansible_ssh_pass=1w98.77B32</span><br></pre></td></tr></table></figure></p></blockquote><h2 id="4-2-初始化服务器环境"><a href="#4-2-初始化服务器环境" class="headerlink" title="4.2 初始化服务器环境"></a>4.2 初始化服务器环境</h2><h3 id="4-2-1-执行脚本"><a href="#4-2-1-执行脚本" class="headerlink" title="4.2.1 执行脚本"></a>4.2.1 执行脚本</h3><blockquote><p>关闭selinux，配置防火墙，配置ntp，添加sudo用户weihu，修改文件描述符，配置主机/etc/hosts文件。 在ansible中执行<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible cdh -m script -a &apos;/root/centos7_init.sh&apos; -f 5</span><br></pre></td></tr></table></figure></p></blockquote><blockquote><p>cento7_init.sh<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line"># Filename:    centos7_init.sh</span><br><span class="line"># Revision:    1.0</span><br><span class="line"># Date:        2016/12/15</span><br><span class="line"># Author:      YangHang</span><br><span class="line"># Email:       13716320887@139.com</span><br><span class="line"># Website:     no</span><br><span class="line"># Description: centos7系统初始化</span><br><span class="line"></span><br><span class="line">#1.定义配置yum源函数--(注：若程序不能联网，则需要配置本地yum源，将地址指向此处)</span><br><span class="line">function yum()&#123;</span><br><span class="line">touch /etc/yum.repos.d/mysql5.7.repo</span><br><span class="line">cat &gt; /etc/yum.repos.d/mysql5.7.repo &lt;&lt; EOF</span><br><span class="line">[mysql5.7]</span><br><span class="line">name=mysql5.7</span><br><span class="line">baseurl=https://mirrors.tuna.tsinghua.edu.cn/mysql/yum/mysql57-community-el7/</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=0</span><br><span class="line">EOF</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#2.定义配置NTP函数</span><br><span class="line">function ntp()&#123;</span><br><span class="line">/usr/bin/yum -y install ntp</span><br><span class="line">#修改配置文件</span><br><span class="line">echo &apos;&apos; &gt;/etc/ntp.conf</span><br><span class="line">cat &gt;&gt;/etc/ntp.conf &lt;&lt; EOF</span><br><span class="line">driftfile /var/lib/ntp/drift</span><br><span class="line">restrict default nomodify notrap nopeer noquery</span><br><span class="line">restrict 127.0.0.1 </span><br><span class="line">restrict ::1</span><br><span class="line">server ntp1.aliyun.com</span><br><span class="line">server ntp2.aliyun.com</span><br><span class="line">server ntp3.aliyun.com</span><br><span class="line">server ntp4.aliyun.com</span><br><span class="line">server ntp5.aliyun.com</span><br><span class="line">includefile /etc/ntp/crypto/pw</span><br><span class="line">keys /etc/ntp/keys</span><br><span class="line">disable monitor</span><br><span class="line">EOF</span><br><span class="line">#同步hwclock</span><br><span class="line">cat &gt;&gt;/etc/sysconfig/ntpd&lt;&lt;EOF</span><br><span class="line">#Command line options for ntpd</span><br><span class="line">SYNC_HWCLOCK=yes</span><br><span class="line">OPTIONS=&quot;-g&quot;</span><br><span class="line">EOF</span><br><span class="line">#使用ntpdate命令校验时间</span><br><span class="line">/usr/sbin/ntpdate ntp2.aliyun.com &amp;&amp; /usr/sbin/hwclock -w</span><br><span class="line">/usr/bin/systemctl stop chronyd &amp;&gt; /dev/null</span><br><span class="line">/usr/bin/systemctl disable chronyd &amp;&gt; /dev/null</span><br><span class="line">/usr/bin/systemctl start ntpd &amp;&gt; /dev/null</span><br><span class="line">/usr/bin/systemctl enable ntpd &amp;&gt; /dev/null</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#3.定义关闭防火墙函数  如果机房漏扫建议将防火墙开启，此函数不执行</span><br><span class="line">function close_firewalld()&#123;</span><br><span class="line">    /usr/bin/systemctl stop firewalld.service &amp;&gt; /dev/null</span><br><span class="line">    /usr/bin/systemctl disable firewalld.service &amp;&gt; /dev/null</span><br><span class="line">&#125;</span><br><span class="line">#4.定义关闭selinux函数</span><br><span class="line">function close_selinux()&#123;</span><br><span class="line">    setenforce 0</span><br><span class="line">    sed -i &apos;s#SELINUX=enforcing#SELINUX=disabled#g&apos; /etc/selinux/config</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#5.调整文件描述符</span><br><span class="line">function optimization()&#123;</span><br><span class="line">echo &quot;* soft nofile 65536&quot; &gt;&gt; /etc/security/limits.conf</span><br><span class="line">echo &quot;* hard nofile 65536&quot; &gt;&gt; /etc/security/limits.conf</span><br><span class="line">echo &quot;* soft nproc 65536&quot; &gt;&gt; /etc/security/limits.conf</span><br><span class="line">echo &quot;* hard nproc 65536&quot; &gt;&gt; /etc/security/limits.conf</span><br><span class="line">&#125;</span><br><span class="line">#6.配置hosts</span><br><span class="line">function host()&#123;</span><br><span class="line">cat &gt;&gt; /etc/hosts &lt;&lt; EOF</span><br><span class="line">168.1.2.180    gxjh01</span><br><span class="line">168.1.2.181    gxjh02</span><br><span class="line">168.1.2.182    gxjh03</span><br><span class="line">168.1.2.183    gxjh04</span><br><span class="line">EOF</span><br><span class="line">&#125;</span><br><span class="line">#7.添加sudo-weihu用户</span><br><span class="line">function add_user()&#123;</span><br><span class="line">useradd weihu</span><br><span class="line">echo &quot;weihu@123!&quot;|passwd --stdin weihu</span><br><span class="line">history -c</span><br><span class="line">sed -i &apos;91a weihu  ALL=(ALL)      NOPASSWD:ALL&apos; /etc/sudoers</span><br><span class="line">&#125;</span><br><span class="line">#8.配置jdk环境变量 注：此处只是</span><br><span class="line">function jdk()&#123;</span><br><span class="line">cat &gt;&gt; /etc/profile &lt;&lt; EOF</span><br><span class="line">export JAVA_HOME=/usr/local/java/jdk1.8.0_144</span><br><span class="line">export CLASSPATH=.:$JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar</span><br><span class="line">export PATH=$JAVA_HOME/bin:$PATH</span><br><span class="line">EOF</span><br><span class="line">&#125;</span><br><span class="line">#9.优化cdh相关参数</span><br><span class="line">function cdh()&#123;</span><br><span class="line">echo never &gt; /sys/kernel/mm/transparent_hugepage/defrag</span><br><span class="line">echo never &gt; /sys/kernel/mm/transparent_hugepage/enabled</span><br><span class="line">echo &quot;vm.swappiness = 10&quot; &gt;&gt; /etc/sysctl.conf</span><br><span class="line">/usr/sbin/sysctl -p</span><br><span class="line">&#125;</span><br><span class="line">#10.配置rc.local 开机自启动</span><br><span class="line">function rc()&#123;</span><br><span class="line">chmod +x /etc/rc.d/rc.local</span><br><span class="line">cat &gt;&gt; /etc/rc.d/rc.local &lt;&lt; EOF</span><br><span class="line">echo never &gt; /sys/kernel/mm/transparent_hugepage/defrag</span><br><span class="line">echo never &gt; /sys/kernel/mm/transparent_hugepage/enabled</span><br><span class="line">#/opt/cm-5.11.2/etc/init.d/cloudera-scm-server restart</span><br><span class="line">/opt/cm-5.11.2/etc/init.d/cloudera-scm-agent restart</span><br><span class="line">EOF</span><br><span class="line">&#125;</span><br><span class="line">#11.服务器用户登录限制 禁止用户登录，禁止使用dns(有的时候会出现ssh和ftp登录时间很长)</span><br><span class="line">function ssh()&#123;</span><br><span class="line">sed -i &apos;s/#PermitRootLogin/PermitRootLogin/g&apos; /etc/ssh/sshd_config</span><br><span class="line">sed -i &quot;s/#UseDNS no/UseDNS no/g&quot; /etc/ssh/sshd_config</span><br><span class="line">systemctl restart sshd</span><br><span class="line">&#125;</span><br><span class="line">#初始化方法</span><br><span class="line">function init()&#123;</span><br><span class="line">    yum;</span><br><span class="line">    ntp;</span><br><span class="line">    close_firewalld;</span><br><span class="line">    close_selinux;</span><br><span class="line">    optimization;</span><br><span class="line">    host;</span><br><span class="line">    add_user;</span><br><span class="line">    jdk;</span><br><span class="line">    cdh;</span><br><span class="line">    rc;</span><br><span class="line">&#125;</span><br><span class="line">init</span><br></pre></td></tr></table></figure></p></blockquote><h3 id="4-2-2-配置主机互信"><a href="#4-2-2-配置主机互信" class="headerlink" title="4.2.2 配置主机互信"></a>4.2.2 配置主机互信</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">-- 各服务器执行ssh-keygen</span><br><span class="line">ansible cdh -m shell -a &quot;ssh-keygen -t rsa -P &apos;&apos; -f ~/.ssh/id_rsa&quot; -f 10</span><br><span class="line">-- 生成authorized_keys文件</span><br><span class="line">ansible cdh -m shell -a &quot;cat /root/.ssh/id_rsa.pub&quot; -f 10 &gt; /tmp/authorized_keys</span><br><span class="line">-- 去除多余的行</span><br><span class="line">sed -i &apos;/SUCCESS/d&apos; /tmp/authorized_keys</span><br><span class="line">-- 分发authorized_keys至每台服务器</span><br><span class="line">ansible cdh -m copy -a &quot;src=/tmp/authorized_keys dest=/root/.ssh/ owner=root group=root mode=0644&quot; -f 10</span><br></pre></td></tr></table></figure><h3 id="4-2-3-配置jdk"><a href="#4-2-3-配置jdk" class="headerlink" title="4.2.3 配置jdk"></a>4.2.3 配置jdk</h3><blockquote><p>由于4.2.1 中脚本已包含配置环境变量，因此直接执行以下操作即可<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ansible cdh -m copy  -a &quot;src=/home/data/software/jdk-8u144-linux-x64.tar.gz dest=/root/jdk-8u144-linux-x64.tar.gz owner=root group=root mode=0644&quot; -f 10</span><br><span class="line">ansible cdh -m shell -a &quot;mkdir -p /usr/local/java/ &quot; -f 5</span><br><span class="line">ansible cdh -m shell -a &quot;tar -zxf /root/jdk-8u144-linux-x64.tar.gz -C /usr/local/java/ &quot; -f 5</span><br><span class="line"></span><br><span class="line">ansible cdh -m shell -a &quot;source /etc/profile&amp;&amp; java -version &quot; -f 5</span><br></pre></td></tr></table></figure></p></blockquote><h2 id="4-3-配置mysql"><a href="#4-3-配置mysql" class="headerlink" title="4.3 配置mysql"></a>4.3 配置mysql</h2><blockquote><p>mysql安装在168.1.2.180 服务器中</p></blockquote><h3 id="4-3-1-配置mysql5-7-repo"><a href="#4-3-1-配置mysql5-7-repo" class="headerlink" title="4.3.1 配置mysql5.7.repo"></a>4.3.1 配置mysql5.7.repo</h3><blockquote><p>文件路径:/etc/yum.repos.d/<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[mysql5.7]</span><br><span class="line">name=mysql5.7</span><br><span class="line">baseurl=https://mirrors.tuna.tsinghua.edu.cn/mysql/yum/mysql57-community-el7/</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=0</span><br></pre></td></tr></table></figure></p></blockquote><h3 id="4-3-1-安装"><a href="#4-3-1-安装" class="headerlink" title="4.3.1 安装"></a>4.3.1 安装</h3><blockquote><p>注：这些服务器安装了多余的包需先卸载掉：yum -y remove mariadb-libs<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">yum -y install mysql-community-server</span><br><span class="line">mkdir -p /home/data/mysql/data</span><br><span class="line">mkdir -p /home/data/mysql/logs</span><br><span class="line">chown -R mysql:mysql /home/data/mysql</span><br></pre></td></tr></table></figure></p></blockquote><h3 id="4-3-2-mysql配置文件"><a href="#4-3-2-mysql配置文件" class="headerlink" title="4.3.2 mysql配置文件"></a>4.3.2 mysql配置文件</h3><blockquote><p>/etc/my.cnf<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"># mysql配置文件</span><br><span class="line">[mysqld]</span><br><span class="line">socket = /var/lib/mysql/mysql.sock</span><br><span class="line">#禁止域名解析</span><br><span class="line">skip-name-resolve</span><br><span class="line">#数据目录</span><br><span class="line">datadir=/home/data/mysql/data</span><br><span class="line">#mysql的server-id</span><br><span class="line">server-id=249</span><br><span class="line">#超时时间</span><br><span class="line">wait_timeout=100</span><br><span class="line">interactive_timeout=100</span><br><span class="line">### binlog设置 ###</span><br><span class="line"># binlog日志设置</span><br><span class="line"># 不强制限制存储函数创建,这个变量也适用于触发器创建</span><br><span class="line">log_bin_trust_function_creators = 1</span><br><span class="line"># binlog存储地址</span><br><span class="line">log_bin = /home/data/mysql/logs/mysql-bin</span><br><span class="line"># binlog格式</span><br><span class="line">binlog_format = row</span><br><span class="line"># binlog过期时间</span><br><span class="line">expire-logs-days = 7</span><br><span class="line"># binlog缓存日志</span><br><span class="line">binlog_cache_size = 2M</span><br><span class="line"># 自增初始值</span><br><span class="line">auto_increment_offset = 1</span><br><span class="line"># 自增间隔</span><br><span class="line">auto_increment_increment = 2 </span><br><span class="line"># 错误日志配置</span><br><span class="line">log_error = /home/data/mysql/logs/mysql-error.log</span><br><span class="line"># 慢日志配置</span><br><span class="line">slow_query_log = 1</span><br><span class="line">slow_query_log_file = /home/data/mysql/logs/mysql-slow.log</span><br><span class="line">long_query_time = 5</span><br><span class="line">### innodb ###</span><br><span class="line">innodb_write_io_threads = 32</span><br><span class="line">innodb_read_io_threads = 32</span><br><span class="line">innodb_buffer_pool_size = 1G</span><br><span class="line">innodb_file_per_table = 1</span><br><span class="line">innodb_log_file_size = 50M</span><br><span class="line">innodb_log_buffer_size = 64M</span><br><span class="line">### 优化配置 ###</span><br><span class="line">max_connections = 1024</span><br><span class="line">max_connect_errors = 1000</span><br><span class="line">lower_case_table_names = 1</span><br><span class="line">key_buffer_size = 64M</span><br><span class="line">table_open_cache = 6144</span><br><span class="line">table_definition_cache = 4096</span><br><span class="line">sort_buffer_size = 512K</span><br><span class="line">read_buffer_size = 512K</span><br><span class="line">join_buffer_size = 512K</span><br><span class="line">tmp_table_size = 64M</span><br><span class="line">max_heap_table_size = 64M</span><br><span class="line"># 接收的数据包大小</span><br><span class="line">max_allowed_packet = 1024M</span><br><span class="line">#mysql5.6和mysql5.7默认的sql_mode不一样</span><br><span class="line">#sql_mode = STRICT_TRANS_TABLES,NO_ENGINE_SUBSTITUTION</span><br><span class="line"># 开启查询缓存</span><br><span class="line">explicit_defaults_for_timestamp=true</span><br></pre></td></tr></table></figure></p></blockquote><h3 id="4-3-3-初始化mysql库"><a href="#4-3-3-初始化mysql库" class="headerlink" title="4.3.3 初始化mysql库"></a>4.3.3 初始化mysql库</h3><blockquote><p>初始化mysql库<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqld --initialize-insecure --user=mysql</span><br></pre></td></tr></table></figure></p></blockquote><h3 id="4-3-4-启动mysql"><a href="#4-3-4-启动mysql" class="headerlink" title="4.3.4 启动mysql"></a>4.3.4 启动mysql</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl start mysqld</span><br><span class="line">systemctl enable mysqld</span><br></pre></td></tr></table></figure><h3 id="4-3-5-执行mysql-secure-installation"><a href="#4-3-5-执行mysql-secure-installation" class="headerlink" title="4.3.5 执行mysql_secure_installation"></a>4.3.5 执行mysql_secure_installation</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# mysql_secure_installation</span><br><span class="line"></span><br><span class="line">Securing the MySQL server deployment.</span><br><span class="line"></span><br><span class="line">Connecting to MySQL using a blank password.</span><br><span class="line"></span><br><span class="line">VALIDATE PASSWORD PLUGIN can be used to test passwords</span><br><span class="line">and improve security. It checks the strength of password</span><br><span class="line">and allows the users to set only those passwords which are</span><br><span class="line">secure enough. Would you like to setup VALIDATE PASSWORD plugin?</span><br><span class="line"></span><br><span class="line">Press y|Y for Yes, any other key for No: n</span><br><span class="line">Please set the password for root here.</span><br><span class="line"></span><br><span class="line">New password: </span><br><span class="line"></span><br><span class="line">Re-enter new password: </span><br><span class="line">By default, a MySQL installation has an anonymous user,</span><br><span class="line">allowing anyone to log into MySQL without having to have</span><br><span class="line">a user account created for them. This is intended only for</span><br><span class="line">testing, and to make the installation go a bit smoother.</span><br><span class="line">You should remove them before moving into a production</span><br><span class="line">environment.</span><br><span class="line"></span><br><span class="line">Remove anonymous users? (Press y|Y for Yes, any other key for No) : Y</span><br><span class="line">Success.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Normally, root should only be allowed to connect from</span><br><span class="line">&apos;localhost&apos;. This ensures that someone cannot guess at</span><br><span class="line">the root password from the network.</span><br><span class="line"></span><br><span class="line">Disallow root login remotely? (Press y|Y for Yes, any other key for No) : y</span><br><span class="line">Success.</span><br><span class="line"></span><br><span class="line">By default, MySQL comes with a database named &apos;test&apos; that</span><br><span class="line">anyone can access. This is also intended only for testing,</span><br><span class="line">and should be removed before moving into a production</span><br><span class="line">environment.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Remove test database and access to it? (Press y|Y for Yes, any other key for No) : y</span><br><span class="line"> - Dropping test database...</span><br><span class="line">Success.</span><br><span class="line"></span><br><span class="line"> - Removing privileges on test database...</span><br><span class="line">Success.</span><br><span class="line"></span><br><span class="line">Reloading the privilege tables will ensure that all changes</span><br><span class="line">made so far will take effect immediately.</span><br><span class="line"></span><br><span class="line">Reload privilege tables now? (Press y|Y for Yes, any other key for No) : y</span><br><span class="line">Success.</span><br><span class="line"></span><br><span class="line">All done! </span><br><span class="line">[root@localhost ~]#</span><br></pre></td></tr></table></figure><h3 id="4-3-3-创建hive库"><a href="#4-3-3-创建hive库" class="headerlink" title="4.3.3 创建hive库"></a>4.3.3 创建hive库</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CREATE DATABASE `hive` DEFAULT CHARACTER SET utf8 COLLATE utf8_general_ci;</span><br></pre></td></tr></table></figure><h2 id="4-4-配置CDH"><a href="#4-4-配置CDH" class="headerlink" title="4.4 配置CDH"></a>4.4 配置CDH</h2><blockquote><p>CDH包含server和agent两个，server用于管理，agent用于承载各种角色服务，本次规划使用在gxjh01上配置server+agent，另外三台运行agent</p></blockquote><h3 id="4-4-1-配置cm-server"><a href="#4-4-1-配置cm-server" class="headerlink" title="4.4.1 配置cm-server"></a>4.4.1 配置cm-server</h3><blockquote><p>在gxjh01服务器上执行，由于服务器中存储空间大不放在/home/目录中，考虑到cdh默认在/opt目录下因此，使用软链接将/opt/cloudera 和/opt/cm-11.2目录链接到/home/data/cloudera 和/home/data/cm-11.2下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">#初始化安装文件</span><br><span class="line">tar zxvf cloudera-manager-centos7-cm5.11.2_x86_64.tar.gz -C /home/data/</span><br><span class="line">mkdir -p /opt/cloudera/parcel-repo/</span><br><span class="line">#添加软连接</span><br><span class="line">ln -s /home/data/cloudera /opt/cloudera</span><br><span class="line">ln -s /home/data/cm-5.11.2 /opt/cm-5.11.2</span><br><span class="line">chmod 777 /home/data/software/mysql-connector-java-5.1.39-bin.jar</span><br><span class="line"></span><br><span class="line">cp /home/data/software/mysql-connector-java-5.1.39-bin.jar /opt/cm-5.11.2/share/cmf/lib/mysql-connector-java.jar</span><br><span class="line">mv CDH-5.11.2-1.cdh5.11.2.p0.4-el7.parcel.sha1 CDH-5.11.2-1.cdh5.11.2.p0.4-el7.parcel.sha</span><br><span class="line">mv CDH-5.11.2-1.cdh5.11.2.p0.4-el7.parcel* /opt/cloudera/parcel-repo/</span><br><span class="line">mv manifest.json /opt/cloudera/parcel-repo/</span><br><span class="line"></span><br><span class="line">#添加用户</span><br><span class="line">useradd --system --home=/opt/cm-5.11.2/run/cloudera-scm-server/ --no-create-home --shell=/bin/false --comment &quot;Cloudera SCM User&quot; cloudera-scm</span><br><span class="line">#初始化cm库</span><br><span class="line">update user set Grant_priv=&apos;Y&apos; where user=&apos;weihu&apos; and Host=&apos;%&apos;;</span><br><span class="line">/opt/cm-5.11.2/share/cmf/schema/scm_prepare_database.sh mysql cm -hlocalhost -uweihu -pweihu123 --scm-host % scm scm scm</span><br><span class="line"></span><br><span class="line">mkdir -p /var/lib/cloudera-scm-server</span><br><span class="line">chown cloudera-scm:cloudera-scm /var/lib/cloudera-scm-server</span><br><span class="line">#修改agent链接的配置文件/opt/cm-5.11.2/etc/cloudera-scm-agent/config.ini</span><br><span class="line">server_host=gxjh01</span><br><span class="line">#启动：</span><br><span class="line">/opt/cm-5.11.2/etc/init.d/cloudera-scm-server restart</span><br></pre></td></tr></table></figure></p></blockquote><h3 id="4-4-2-配置cm-agent配置"><a href="#4-4-2-配置cm-agent配置" class="headerlink" title="4.4.2 配置cm-agent配置"></a>4.4.2 配置cm-agent配置</h3><blockquote><p>将ansible配置组中gxjh01服务器注释掉</p></blockquote><p>#配置用户</p><p>#拷贝安装文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ansible cdh -m copy -a &quot;src=/opt/cm-5.11.2.tar.gz dest=/root/ owner=root group=root mode=0644&quot; -f 4</span><br><span class="line">#创建文件夹</span><br><span class="line">ansible cdh -m shell -a &quot;mkdir -p /home/data&quot; -f 4</span><br><span class="line">ansible cdh -m shell -a &quot;mkdir -p /home/data/cloudera&quot; -f 4</span><br><span class="line">#解压文件</span><br><span class="line">ansible cdh -m shell -a &quot;tar -xf /root/cm-5.11.2.tar.gz -C /home/data&quot; -f 4</span><br><span class="line">#做软连接</span><br><span class="line">ansible cdh -m shell -a &quot;ln -s /home/data/cloudera /opt/cloudera&quot; -f 4</span><br><span class="line">ansible cdh -m shell -a &quot;ln -s /home/data/cm-5.11.2 /opt/cm-5.11.2&quot; -f 4</span><br><span class="line">#配置用户</span><br><span class="line">ansible cdh -m shell -a &apos;useradd --system --home=/opt/cm-5.11.2/run/cloudera-scm-server/ --no-create-home --shell=/bin/false --comment &quot;Cloudera SCM User&quot; cloudera-scm&apos; -f 10</span><br></pre></td></tr></table></figure></p><h3 id="4-5-启动agent和开机自启动"><a href="#4-5-启动agent和开机自启动" class="headerlink" title="4.5 启动agent和开机自启动"></a>4.5 启动agent和开机自启动</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#启动：</span><br><span class="line">/opt/cm-5.11.2/etc/init.d/cloudera-scm-agent start</span><br><span class="line">#开机自启动：</span><br><span class="line">chmod +x /etc/rc.d/rc.local</span><br><span class="line">#添加如下：</span><br><span class="line">/opt/cm-5.11.2/etc/init.d/cloudera-scm-agent restart</span><br></pre></td></tr></table></figure><h3 id="4-6-登陆cm-server控制台，配置集群"><a href="#4-6-登陆cm-server控制台，配置集群" class="headerlink" title="4.6 登陆cm-server控制台，配置集群"></a>4.6 登陆cm-server控制台，配置集群</h3><h4 id="4-6-1-登陆控制台"><a href="#4-6-1-登陆控制台" class="headerlink" title="4.6.1 登陆控制台"></a>4.6.1 登陆控制台</h4><blockquote><p><a href="http://168.1.2.180:7180" target="_blank" rel="noopener">http://168.1.2.180:7180</a>    用户名：admin 密码：admin</p></blockquote><center><img src="https://i.loli.net/2018/11/19/5bf254287aa49.png" alt="01.png" title="01.png"> </center><h4 id="4-6-2-登陆控制台"><a href="#4-6-2-登陆控制台" class="headerlink" title="4.6.2 登陆控制台"></a>4.6.2 登陆控制台</h4><blockquote><p>接受协议</p></blockquote><center><img src="https://i.loli.net/2018/11/19/5bf254492b4f6.png" alt="02.png" title="02.png"> </center><h4 id="4-6-3-选择所要安装的版本"><a href="#4-6-3-选择所要安装的版本" class="headerlink" title="4.6.3 选择所要安装的版本"></a>4.6.3 选择所要安装的版本</h4><blockquote><p>选择免费版本</p></blockquote><center><img src="https://i.loli.net/2018/11/19/5bf25444a77b0.png" alt="03.png" title="03.png"> </center><h4 id="4-6-4-弹出下图"><a href="#4-6-4-弹出下图" class="headerlink" title="4.6.4 弹出下图"></a>4.6.4 弹出下图</h4><center><img src="https://i.loli.net/2018/11/19/5bf25448ea480.png" alt="04.png" title="04.png"> </center><h4 id="4-6-5-选择待安装的主机"><a href="#4-6-5-选择待安装的主机" class="headerlink" title="4.6.5 选择待安装的主机"></a>4.6.5 选择待安装的主机</h4><blockquote><p>根据实际需求选择相应主机</p></blockquote><center><img src="https://i.loli.net/2018/11/19/5bf25444a71c2.png" alt="05.png" title="05.png"> </center><h4 id="4-6-6-弹出下图点击继续"><a href="#4-6-6-弹出下图点击继续" class="headerlink" title="4.6.6 弹出下图点击继续"></a>4.6.6 弹出下图点击继续</h4><center><img src="https://i.loli.net/2018/11/19/5bf254492ae14.png" alt="06.png" title="06.png"> </center><h4 id="4-6-7-弹出下图点击继续"><a href="#4-6-7-弹出下图点击继续" class="headerlink" title="4.6.7 弹出下图点击继续"></a>4.6.7 弹出下图点击继续</h4><center><img src="https://i.loli.net/2018/11/19/5bf254427981e.png" alt="07.png" title="07.png"> </center><h4 id="4-6-8-弹出下图点击继续"><a href="#4-6-8-弹出下图点击继续" class="headerlink" title="4.6.8 弹出下图点击继续"></a>4.6.8 弹出下图点击继续</h4><center><img src="https://i.loli.net/2018/11/19/5bf254427d480.png" alt="08.png" title="08.png"> </center><h4 id="4-6-9-弹出下图点击继续"><a href="#4-6-9-弹出下图点击继续" class="headerlink" title="4.6.9 弹出下图点击继续"></a>4.6.9 弹出下图点击继续</h4><center><img src="https://i.loli.net/2018/11/19/5bf254494548d.png" alt="09.png" title="09.png"> </center><h4 id="4-6-10-选择自定义角色安装"><a href="#4-6-10-选择自定义角色安装" class="headerlink" title="4.6.10 选择自定义角色安装"></a>4.6.10 选择自定义角色安装</h4><blockquote><p>hdfs+yarn+zookeeper+hive+impala</p></blockquote><center><img src="https://i.loli.net/2018/11/19/5bf2545398978.png" alt="10.png" title="10.png"> </center><h4 id="4-6-11-为每个角色选择主机"><a href="#4-6-11-为每个角色选择主机" class="headerlink" title="4.6.11 为每个角色选择主机"></a>4.6.11 为每个角色选择主机</h4><blockquote><p>原则上namenode和datanode不得在同一台，resourcemanager角色单独在一台机器上，由于此次只有四台服务器，因此每台机器都放了多个角色。<br>为Hive Metastore Server角色服务器添加mysql-connector-java.jar</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp /opt/cm-5.11.2/share/cmf/lib/mysql-connector-java.jar /opt/cloudera/parcels/CDH-5.11.2-1.cdh5.11.2.p0.4/lib/hive/lib/</span><br></pre></td></tr></table></figure><center><img src="https://i.loli.net/2018/11/19/5bf254a20c149.png" alt="11.png" title="11.png"> </center><h4 id="4-6-12-配置hive连接的mysql源"><a href="#4-6-12-配置hive连接的mysql源" class="headerlink" title="4.6.12 配置hive连接的mysql源"></a>4.6.12 配置hive连接的mysql源</h4><blockquote><p>cp /opt/cm-5.11.2/share/cmf/lib/mysql-connector-java.jar /opt/cloudera/parcels/CDH-5.11.2-1.cdh5.11.2.p0.4/lib/hive/lib/</p></blockquote><center><img src="https://i.loli.net/2018/11/19/5bf254a4398f8.png" alt="12.png" title="12.png"> </center><h4 id="4-6-13-弹出下图-根据实际需求更改相应目录，点击继续，安装完成后集群配置完毕"><a href="#4-6-13-弹出下图-根据实际需求更改相应目录，点击继续，安装完成后集群配置完毕" class="headerlink" title="4.6.13 弹出下图,根据实际需求更改相应目录，点击继续，安装完成后集群配置完毕"></a>4.6.13 弹出下图,根据实际需求更改相应目录，点击继续，安装完成后集群配置完毕</h4><center><img src="https://i.loli.net/2018/11/19/5bf254ad52bc3.png" alt="13.png" title="13.png"> </center><h4 id="4-6-14-配置yarn-ha"><a href="#4-6-14-配置yarn-ha" class="headerlink" title="4.6.14 配置yarn ha"></a>4.6.14 配置yarn ha</h4><blockquote><p>启用高可用，选择备用主机</p></blockquote><center><img src="https://i.loli.net/2018/11/19/5bf254ad522e4.png" alt="1401.png" title="1401.png"> </center><br><center><img src="https://i.loli.net/2018/11/19/5bf254a5bcbaf.png" alt="14.png" title="14.png"> </center><h4 id="4-6-16-启用hdfs-ha"><a href="#4-6-16-启用hdfs-ha" class="headerlink" title="4.6.16 启用hdfs ha"></a>4.6.16 启用hdfs ha</h4><center><img src="https://i.loli.net/2018/11/19/5bf254c9b8126.png" alt="15.png" title="15.png"> </center><h4 id="4-6-17-配置namenode-server名称"><a href="#4-6-17-配置namenode-server名称" class="headerlink" title="4.6.17 配置namenode server名称"></a>4.6.17 配置namenode server名称</h4><center><img src="https://i.loli.net/2018/11/19/5bf254c74d512.png" alt="16.png" title="16.png"> </center><h4 id="4-6-18-选择备用hdfs主机"><a href="#4-6-18-选择备用hdfs主机" class="headerlink" title="4.6.18 选择备用hdfs主机"></a>4.6.18 选择备用hdfs主机</h4><center><img src="https://i.loli.net/2018/11/19/5bf254c9b74c7.png" alt="17.png" title="17.png"> </center><h4 id="4-6-18-设置目录"><a href="#4-6-18-设置目录" class="headerlink" title="4.6.18 设置目录"></a>4.6.18 设置目录</h4><center><img src="https://i.loli.net/2018/11/19/5bf254cb93962.png" alt="18.png" title="18.png"> </center><h4 id="4-6-19-点击继续"><a href="#4-6-19-点击继续" class="headerlink" title="4.6.19 点击继续"></a>4.6.19 点击继续</h4><center><img src="https://i.loli.net/2018/11/19/5bf254cc5cfc7.png" alt="19.png" title="19.png"> </center><h4 id="4-6-20-至此，hdfs高可用完毕"><a href="#4-6-20-至此，hdfs高可用完毕" class="headerlink" title="4.6.20 至此，hdfs高可用完毕"></a>4.6.20 至此，hdfs高可用完毕</h4><center><img src="https://i.loli.net/2018/11/19/5bf254a2c3510.png" alt="20.png" title="20.png"> </center><h3 id="4-7-配置nginx负载均衡impalad"><a href="#4-7-配置nginx负载均衡impalad" class="headerlink" title="4.7 配置nginx负载均衡impalad"></a>4.7 配置nginx负载均衡impalad</h3><h4 id="4-7-1-安装"><a href="#4-7-1-安装" class="headerlink" title="4.7.1 安装"></a>4.7.1 安装</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">#安装依赖</span><br><span class="line">yum install pcre-devel zlib-devel openssl-devel -y</span><br><span class="line">#编译</span><br><span class="line">./configure --prefix=/home/data/nginx --with-http_ssl_module --with-http_flv_module --with-http_stub_status_module --with-http_gzip_static_module  --with-stream</span><br><span class="line">#安装</span><br><span class="line">make &amp;&amp; make install</span><br><span class="line">#编辑配置文件 cat /home/data/nginx/conf/nginx.conf</span><br><span class="line">worker_processes  8;</span><br><span class="line">worker_rlimit_nofile 65535;</span><br><span class="line"></span><br><span class="line">error_log  logs/error.log;</span><br><span class="line">pid        logs/nginx.pid;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    use  epoll;</span><br><span class="line">    worker_connections  65535;</span><br><span class="line">&#125;</span><br><span class="line">stream &#123;</span><br><span class="line">    server &#123;</span><br><span class="line">        listen 31050;</span><br><span class="line">        proxy_pass impala;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    upstream impala &#123;</span><br><span class="line">server 168.1.2.180:21050;</span><br><span class="line">server 168.1.2.181:21050;</span><br><span class="line">server 168.1.2.182:21050;</span><br><span class="line">server 168.1.2.183:21050;   </span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4-7-2-启动-amp-amp-停止"><a href="#4-7-2-启动-amp-amp-停止" class="headerlink" title="4.7.2 启动&amp;&amp;停止"></a>4.7.2 启动&amp;&amp;停止</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">启动：/home/data/nginx/sbin/nginx</span><br><span class="line">停止：pkill -9 nginx</span><br></pre></td></tr></table></figure><h4 id="4-7-3-连接地址"><a href="#4-7-3-连接地址" class="headerlink" title="4.7.3 连接地址"></a>4.7.3 连接地址</h4><blockquote><p>168.1.2.180:31050</p></blockquote><h3 id="4-8-java程序连接集群的配置文件"><a href="#4-8-java程序连接集群的配置文件" class="headerlink" title="4.8 java程序连接集群的配置文件"></a>4.8 java程序连接集群的配置文件</h3><blockquote><p>配置文件包含两个:hdfs-site.xml 和core-site.xml<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/etc/hadoop/conf.cloudera.hdfs/core-site.xml</span><br><span class="line">/etc/hadoop/conf.cloudera.hdfs/hdfs-site.xml</span><br></pre></td></tr></table></figure></p></blockquote><h2 id="5-集群维护"><a href="#5-集群维护" class="headerlink" title="5 集群维护"></a>5 集群维护</h2><blockquote><p>本章用来介绍如何操作cdh集群的启停</p></blockquote><h3 id="5-1-启动"><a href="#5-1-启动" class="headerlink" title="5.1 启动"></a>5.1 启动</h3><h4 id="5-1-1-启动mysql"><a href="#5-1-1-启动mysql" class="headerlink" title="5.1.1 启动mysql"></a>5.1.1 启动mysql</h4><blockquote><p>mysql安装地址为gxjh01上<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl start mysql</span><br></pre></td></tr></table></figure></p></blockquote><h4 id="5-1-2-启动cm-server"><a href="#5-1-2-启动cm-server" class="headerlink" title="5.1.2 启动cm-server"></a>5.1.2 启动cm-server</h4><blockquote><p>cm-server部署在gxjh01上<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">opt/cm-5.11.2/etc/init.d/cloudera-scm-server start</span><br></pre></td></tr></table></figure></p></blockquote><h4 id="5-1-3-启动cm-agent"><a href="#5-1-3-启动cm-agent" class="headerlink" title="5.1.3 启动cm-agent"></a>5.1.3 启动cm-agent</h4><blockquote><p>cm-agent部署在gxjh[01:04]上<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">opt/cm-5.11.2/etc/init.d/cloudera-scm-agent start</span><br></pre></td></tr></table></figure></p></blockquote><h4 id="5-1-4-启动nginx"><a href="#5-1-4-启动nginx" class="headerlink" title="5.1.4 启动nginx"></a>5.1.4 启动nginx</h4><blockquote><p>nginx安装地址为gxjh01上<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/home/data/nginx/sbin/nginx</span><br></pre></td></tr></table></figure></p></blockquote><h4 id="5-1-5-登陆cm-server-web界面管理集群"><a href="#5-1-5-登陆cm-server-web界面管理集群" class="headerlink" title="5.1.5 登陆cm-server web界面管理集群"></a>5.1.5 登陆cm-server web界面管理集群</h4><blockquote><p>通过界面启动集群</p></blockquote><center><img src="https://i.loli.net/2018/11/19/5bf261d74f247.png" alt="21.png" title="21.png"></center><h4 id="5-2-关闭"><a href="#5-2-关闭" class="headerlink" title="5.2 关闭"></a>5.2 关闭</h4><h4 id="5-2-1-登陆cm-server-web界面管理集群"><a href="#5-2-1-登陆cm-server-web界面管理集群" class="headerlink" title="5.2.1 登陆cm-server web界面管理集群"></a>5.2.1 登陆cm-server web界面管理集群</h4><blockquote><p>通过界面关闭集群</p></blockquote><center><img src="https://i.loli.net/2018/11/19/5bf261d74f247.png" alt="21.png" title="21.png"></center><h4 id="5-2-2-关闭nginx"><a href="#5-2-2-关闭nginx" class="headerlink" title="5.2.2 关闭nginx"></a>5.2.2 关闭nginx</h4><blockquote><p>nginx安装地址为gxjh01上<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pkill -9 nginx</span><br></pre></td></tr></table></figure></p></blockquote><h4 id="5-2-3-关闭cm-agent"><a href="#5-2-3-关闭cm-agent" class="headerlink" title="5.2.3 关闭cm-agent"></a>5.2.3 关闭cm-agent</h4><blockquote><p>cm-agent部署在gxjh[01:04]上<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">opt/cm-5.11.2/etc/init.d/cloudera-scm-agent stop</span><br></pre></td></tr></table></figure></p></blockquote><h4 id="5-2-4-关闭cm-server"><a href="#5-2-4-关闭cm-server" class="headerlink" title="5.2.4 关闭cm-server"></a>5.2.4 关闭cm-server</h4><blockquote><p>cm-server部署在gxjh01上<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">opt/cm-5.11.2/etc/init.d/cloudera-scm-server stop</span><br></pre></td></tr></table></figure></p></blockquote><h4 id="5-2-5-关闭mysql"><a href="#5-2-5-关闭mysql" class="headerlink" title="5.2.5 关闭mysql"></a>5.2.5 关闭mysql</h4><blockquote><p>mysql安装地址为gxjh01上<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop mysql</span><br></pre></td></tr></table></figure></p></blockquote>]]></content>
      
      
      
        <tags>
            
            <tag> 大数据 </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>docker入门指南</title>
      <link href="/2018/12/18/docker%E5%85%A5%E9%97%A8%E6%8C%87%E5%8D%97/"/>
      <url>/2018/12/18/docker%E5%85%A5%E9%97%A8%E6%8C%87%E5%8D%97/</url>
      
        <content type="html"><![CDATA[<h3 id="1-概述"><a href="#1-概述" class="headerlink" title="1 概述"></a>1 概述</h3><h4 id="1-1-什么是docker"><a href="#1-1-什么是docker" class="headerlink" title="1.1 什么是docker"></a>1.1 什么是docker</h4><h4 id="1-2-docker优点"><a href="#1-2-docker优点" class="headerlink" title="1.2 docker优点"></a>1.2 docker优点</h4><pre><code>1.不需要安装操作系统，秒级启动，可充分利用服务器资源2.方便部署</code></pre><h4 id="1-3-公司准备使用场景"><a href="#1-3-公司准备使用场景" class="headerlink" title="1.3 公司准备使用场景"></a>1.3 公司准备使用场景</h4><h5 id="1-3-1-搭建演示环境"><a href="#1-3-1-搭建演示环境" class="headerlink" title="1.3.1 搭建演示环境"></a>1.3.1 搭建演示环境</h5><blockquote><p>将程序统一打包至一个镜像中统一打包，方便</p></blockquote><h5 id="1-3-2-搭建开发测试环境"><a href="#1-3-2-搭建开发测试环境" class="headerlink" title="1.3.2 搭建开发测试环境"></a>1.3.2 搭建开发测试环境</h5><blockquote><p>在公司搭建私有镜像仓库。创建公共镜像源，如：tomcat+jdk镜像、zabbix镜像、jdk镜像、vsftp镜像</p></blockquote><h5 id="1-3-3-搭建生产环境"><a href="#1-3-3-搭建生产环境" class="headerlink" title="1.3.3 搭建生产环境"></a>1.3.3 搭建生产环境</h5><blockquote><p>在公司生成产品镜像。使用docker export 导出至生产环境中，生产环境使用docker import 导入。</p></blockquote><h3 id="2-docker-安装"><a href="#2-docker-安装" class="headerlink" title="2 docker 安装"></a>2 docker 安装</h3><h4 id="2-1-centos7"><a href="#2-1-centos7" class="headerlink" title="2.1 centos7"></a>2.1 centos7</h4><blockquote><p>由于docker已经放在centos7的extra源内，因此可直接使用yum进行安装配置。</p></blockquote><h5 id="2-1-1-安装"><a href="#2-1-1-安装" class="headerlink" title="2.1.1 安装"></a>2.1.1 安装</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install docker</span><br></pre></td></tr></table></figure><h5 id="2-1-2-修改docker存储目录"><a href="#2-1-2-修改docker存储目录" class="headerlink" title="2.1.2 修改docker存储目录"></a>2.1.2 修改docker存储目录</h5><blockquote><p>修改配置文件/etc/sysconfig/docker<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">OPTIONS=&apos;--graph=/data/docker --selinux-enabled --log-driver=journald --signature-verification=false&apos;</span><br><span class="line">注：--graph=/data/docker即为修改docker默认路径</span><br></pre></td></tr></table></figure></p></blockquote><h5 id="2-1-3-配置docker镜像加速器"><a href="#2-1-3-配置docker镜像加速器" class="headerlink" title="2.1.3 配置docker镜像加速器"></a>2.1.3 配置docker镜像加速器</h5><blockquote><p>镜像加速器有利于快速下载镜像,修改如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@node249 tomcat8_jre8_supervisor]# cat /etc/docker/daemon.json</span><br><span class="line">&#123;</span><br><span class="line">  &quot;registry-mirrors&quot;: [&quot;https://docker.mirrors.ustc.edu.cn&quot;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p></blockquote><h5 id="2-1-4-启停服务-amp-开机自启动"><a href="#2-1-4-启停服务-amp-开机自启动" class="headerlink" title="2.1.4 启停服务&amp;开机自启动"></a>2.1.4 启停服务&amp;开机自启动</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">重新加载配置文件：systemctl daemon-reload</span><br><span class="line">启动：systemctl start docker.service</span><br><span class="line">停止：systemctl stop docker.service</span><br><span class="line">开机自启动：systemctl enable docker.service</span><br></pre></td></tr></table></figure><h3 id="3-镜像操作"><a href="#3-镜像操作" class="headerlink" title="3 镜像操作"></a>3 镜像操作</h3><h4 id="3-1-搜索镜像"><a href="#3-1-搜索镜像" class="headerlink" title="3.1 搜索镜像"></a>3.1 搜索镜像</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker search centos</span><br></pre></td></tr></table></figure><h4 id="3-2-获取镜像"><a href="#3-2-获取镜像" class="headerlink" title="3.2 获取镜像"></a>3.2 获取镜像</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker push docker.io/centos</span><br></pre></td></tr></table></figure><h4 id="3-3-删除镜像"><a href="#3-3-删除镜像" class="headerlink" title="3.3 删除镜像"></a>3.3 删除镜像</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker rmi docker.io/centos</span><br></pre></td></tr></table></figure><h4 id="3-4-制作镜像"><a href="#3-4-制作镜像" class="headerlink" title="3.4 制作镜像"></a>3.4 制作镜像</h4><h5 id="3-4-1-制作tomcat镜像"><a href="#3-4-1-制作tomcat镜像" class="headerlink" title="3.4.1 制作tomcat镜像"></a>3.4.1 制作tomcat镜像</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"># 目录结构</span><br><span class="line">[root@node249 tomcat8-jre8]# pwd</span><br><span class="line">/data/images/tomcat8-jre8</span><br><span class="line">[root@node249 tomcat8-jre8]# tree -L 2</span><br><span class="line">.</span><br><span class="line">├── Dockerfile</span><br><span class="line">├── java</span><br><span class="line">│   └── jre1.8.0_192</span><br><span class="line">└── tomcat</span><br><span class="line">    ├── bin</span><br><span class="line">    ├── conf</span><br><span class="line">    ├── lib</span><br><span class="line">    ├── LICENSE</span><br><span class="line">    ├── logs</span><br><span class="line">    ├── NOTICE</span><br><span class="line">    ├── RELEASE-NOTES</span><br><span class="line">    ├── RUNNING.txt</span><br><span class="line">    ├── temp</span><br><span class="line">    ├── webapps</span><br><span class="line">    └── work</span><br><span class="line"></span><br><span class="line">10 directories, 5 files</span><br><span class="line"># Dockerfile内容</span><br><span class="line">[root@node249 tomcat8-jre8]# cat Dockerfile </span><br><span class="line">#构建tomcat8基础镜像</span><br><span class="line">#引用基础镜像</span><br><span class="line">FROM docker.io/centos</span><br><span class="line">MAINTAINER yanghang &quot;yanghang0717@139.com&quot;</span><br><span class="line"></span><br><span class="line">#创建文件夹</span><br><span class="line">RUN mkdir -p /data/java</span><br><span class="line">RUN mkdir -p /data/tomcat</span><br><span class="line">#将容器时间和主机时间设成一致</span><br><span class="line">RUN cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime &amp;&amp; echo &apos;Asia/Shanghai&apos; &gt;/etc/timezone</span><br><span class="line">#把当前目录下的文件夹添加到镜像中</span><br><span class="line">ADD java /data/java</span><br><span class="line">ADD tomcat /data/tomcat</span><br><span class="line">#添加环境变量</span><br><span class="line">ENV CATALINA_HOME /data/tomcat</span><br><span class="line">ENV JAVA_HOME /data/java/jre1.8.0_192</span><br><span class="line">ENV PATH $CATALINA_HOME/bin:$JAVA_HOME/bin:$PATH</span><br><span class="line">WORKDIR $CATALINA_HOME</span><br><span class="line">#暴露8080端口</span><br><span class="line">EXPOSE 8080</span><br><span class="line"></span><br><span class="line">#启动时运行tomcat</span><br><span class="line">CMD [&quot;/usr/local/tomcat/bin/catalina.sh&quot;, &quot;run&quot;]</span><br><span class="line"></span><br><span class="line"># 制作tomcat镜像</span><br><span class="line">docker build -t tomcat8 .</span><br><span class="line">docker build -t centos7_zh .</span><br></pre></td></tr></table></figure><h4 id="3-4-2-制作jar镜像"><a href="#3-4-2-制作jar镜像" class="headerlink" title="3.4.2 制作jar镜像"></a>3.4.2 制作jar镜像</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;img src=&quot;https://ae01.alicdn.com/kf/HTB1wl18aMZC2uNjSZFn761xZpXaU.png&quot;&gt;</span><br></pre></td></tr></table></figure><h3 id="4-容器操作"><a href="#4-容器操作" class="headerlink" title="4 容器操作"></a>4 容器操作</h3><h4 id="4-1-根据镜像创建容器"><a href="#4-1-根据镜像创建容器" class="headerlink" title="4.1 根据镜像创建容器"></a>4.1 根据镜像创建容器</h4><h5 id="4-1-1-创建tomcat容器"><a href="#4-1-1-创建tomcat容器" class="headerlink" title="4.1.1 创建tomcat容器"></a>4.1.1 创建tomcat容器</h5><blockquote><p>注:tomcat开发测试环境建议网络使用桥接网络，生产环境由于使用独立服务器，因此使用host网络模式。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># 开发测试环境</span><br><span class="line">docker run -itd --restart=always -p 10001:8080 -v /data/mvtech/blxx_netmanager/tomcat/logs:/data/tomcat/logs -v /data/mvtech/blxx_netmanager/tomcat/webapps/ROOT:/data/tomcat/webapps/ROOT --privileged --name=blxx_netmanager tomcat8</span><br><span class="line"># 生产环境</span><br><span class="line">docker run -itd --restart=always --network host -v /data/mvtech/blxx_netmanager/tomcat/logs:/data/tomcat/logs -v /data/mvtech/blxx_netmanager/tomcat/webapps/ROOT:/data/tomcat/webapps/ROOT --privileged --name=blxx_netmanager tomcat8</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">docker run -itd --restart=always -p 10080:8080 -v /blxx/tomcat/logs:/data/tomcat/logs -v /blxx/tomcat/webapps/blxx_mobile:/data/tomcat/webapps/blxx_mobile --privileged --name=blxx_mobile centos7_zh_jdk8_tomcat8</span><br><span class="line"></span><br><span class="line">docker pull 192.168.2.249/library/centos7_zh_jdk8_tomcat8:v1.0</span><br><span class="line"></span><br><span class="line">docker run -itd --restart=always -p 10080:8080 -v /blxx/tomcat/logs:/data/tomcat/logs -v /blxx/tomcat/webapps/blxx_mobile:/data/tomcat/webapps/blxx_mobile --privileged --name=blxx_mobile 192.168.2.249/library/centos7_zh_jdk8_tomcat8:v1.0</span><br></pre></td></tr></table></figure></p></blockquote><h5 id="4-1-2-创建vsftp容器"><a href="#4-1-2-创建vsftp容器" class="headerlink" title="4.1.2 创建vsftp容器"></a>4.1.2 创建vsftp容器</h5><blockquote><p>ftp镜像建议使用host网络模式，因为桥接模式会报错。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">docker run  -d --restart=always --network host -v /data/ftp_root/:/home/vsftpd -e FTP_USER=mvtechftp -e FTP_PASS=mvtech123 --privileged --name mvtechftp docker.io/fauria/vsftpd</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">docker run  -d --restart=always --network host -v /data/ftp_root/:/home/vsftpd --privileged --name vsftpd vsftpd</span><br><span class="line"></span><br><span class="line">docker pull 192.168.2.249/library/centos7-vsftpd:latest</span><br></pre></td></tr></table></figure></p></blockquote><h4 id="4-1-3-创建jdk环境"><a href="#4-1-3-创建jdk环境" class="headerlink" title="4.1.3 创建jdk环境"></a>4.1.3 创建jdk环境</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -itd --restart=always --privileged --name=centos centos /bin/bash</span><br></pre></td></tr></table></figure><h4 id="4-1-4-创建centos容器"><a href="#4-1-4-创建centos容器" class="headerlink" title="4.1.4 创建centos容器"></a>4.1.4 创建centos容器</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">docker run -itd --restart=always --privileged --name=zabbix-server docker.io/centos /usr/sbin/init</span><br><span class="line"></span><br><span class="line">docker run -itd --restart=always --network host   --privileged -v /data/ftp_root/mvtechftp:/data/ftp_root/mvtechftp --privileged --name=vsftpd 192.168.2.249/library/centos7-vsftpd /usr/sbin/init</span><br><span class="line"></span><br><span class="line">docker run -itd --restart=always --network host   --privileged -v /data/ftp_root/mvtechftp:/data/ftp_root/mvtechftp --name=centos centos7-vsftpd /usr/sbin/init</span><br><span class="line">/data/ftp_root/mvtechftp</span><br><span class="line"></span><br><span class="line">docker run -itd --restart=always --network host  --privileged --name=zabbix2.4.8 centos7.5-zabbix2.4.8-zh_cn /usr/sbin/init</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">docker run -itd --restart=always --network host  --privileged --name=zabbix2.4.8 zabbix2.4.8 /usr/sbin/init</span><br><span class="line">docker run -itd --restart=always --network host  --privileged --name=centos7_zh centos7_zh /usr/sbin/init</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">docker pull 192.168.2.249/library/zabbix2.4.8:v1.0</span><br><span class="line"></span><br><span class="line">docker pull 192.168.2.249/library/centos</span><br><span class="line"></span><br><span class="line">docker run -itd --restart=always --network host  --privileged --name=zabbix2.4.8 192.168.2.249/library/zabbix2.4.8:v1.0 /usr/sbin/init</span><br><span class="line"></span><br><span class="line">docker run -itd --restart=always --network host  --privileged --name=centos_dw_crawler 192.168.2.249/library/centos /usr/sbin/init</span><br><span class="line"></span><br><span class="line">docker run -itd --restart=always --network host  --privileged --name=centos_zh 192.168.2.249/library/centos7_zh /usr/sbin/init</span><br><span class="line"></span><br><span class="line">进入容器内部</span><br><span class="line">docker exec -it zabbix2.4.8 /bin/bash</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">docker run -d --restart=always -p 3306:3306 -v /d/work/docker/mysql5.7.24:/data --privileged --name=mysql:5.7.24 192.168.2.249/library/mysql:5.7.24 /usr/sbin/init</span><br></pre></td></tr></table></figure><h4 id="4-2-查看容器详情"><a href="#4-2-查看容器详情" class="headerlink" title="4.2 查看容器详情"></a>4.2 查看容器详情</h4><p>docker inspect test</p><h4 id="4-3-查看容器日志"><a href="#4-3-查看容器日志" class="headerlink" title="4.3 查看容器日志"></a>4.3 查看容器日志</h4><p>docker logs -f -t –tail 10 test</p><h4 id="4-4-导出镜像"><a href="#4-4-导出镜像" class="headerlink" title="4.4 导出镜像"></a>4.4 导出镜像</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker export zabbix-server &gt; zabbix-server.tar</span><br></pre></td></tr></table></figure><h4 id="4-5-导入镜像"><a href="#4-5-导入镜像" class="headerlink" title="4.5 导入镜像"></a>4.5 导入镜像</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker import - za &lt; zabbix-server.tar</span><br><span class="line">docker import http://192.168.2.253/file/zabbix-server.tar zabbix2.4.8</span><br></pre></td></tr></table></figure><h3 id="5-搭建Harbor企业级docker仓库"><a href="#5-搭建Harbor企业级docker仓库" class="headerlink" title="5 搭建Harbor企业级docker仓库"></a>5 搭建Harbor企业级docker仓库</h3><h4 id="5-1-环境准备"><a href="#5-1-环境准备" class="headerlink" title="5.1 环境准备"></a>5.1 环境准备</h4><h5 id="5-1-1-安装docker"><a href="#5-1-1-安装docker" class="headerlink" title="5.1.1 安装docker"></a>5.1.1 安装docker</h5><blockquote><p>请参考第2章 安装docker</p></blockquote><h5 id="5-1-2-安装docker-compose"><a href="#5-1-2-安装docker-compose" class="headerlink" title="5.1.2 安装docker-compose"></a>5.1.2 安装docker-compose</h5><blockquote><p>注：操作系统不自带pip 请自行安装<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install docker-compose</span><br></pre></td></tr></table></figure></p></blockquote><h5 id="5-1-3-下载harbor"><a href="#5-1-3-下载harbor" class="headerlink" title="5.1.3 下载harbor"></a>5.1.3 下载harbor</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">url地址：https://github.com/goharbor/harbor/releases</span><br><span class="line">选择所需版本。我所下载的为：harbor-online-installer-v1.6.0.tgz</span><br><span class="line">tar -zxf /root/harbor-online-installer-v1.6.0.tgz -C /usr/local/</span><br></pre></td></tr></table></figure><h5 id="5-1-4-修改配置文件harbor-cfg"><a href="#5-1-4-修改配置文件harbor-cfg" class="headerlink" title="5.1.4 修改配置文件harbor.cfg"></a>5.1.4 修改配置文件harbor.cfg</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">hostname = 192.168.2.46 </span><br><span class="line">harbor_admin_password = mvtech123</span><br><span class="line">self_registration = off</span><br><span class="line">project_creation_restriction = adminonly</span><br></pre></td></tr></table></figure><h5 id="5-1-5-安装前检查"><a href="#5-1-5-安装前检查" class="headerlink" title="5.1.5 安装前检查"></a>5.1.5 安装前检查</h5><center><img src="https://i.loli.net/2018/10/23/5bceaded63c1f.png" alt="04.png" title="04.png"></center><h4 id="5-2-安装harbor"><a href="#5-2-安装harbor" class="headerlink" title="5.2 安装harbor"></a>5.2 安装harbor</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><span class="line">[root@harbor ~]# /usr/local/harbor/install.sh </span><br><span class="line"></span><br><span class="line">[Step 0]: checking installation environment ...</span><br><span class="line"></span><br><span class="line">Note: docker version: 1.13.1</span><br><span class="line"></span><br><span class="line">Note: docker-compose version: 1.22.0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[Step 1]: preparing environment ...</span><br><span class="line">Clearing the configuration file: ./common/config/adminserver/env</span><br><span class="line">Clearing the configuration file: ./common/config/ui/env</span><br><span class="line">Clearing the configuration file: ./common/config/ui/app.conf</span><br><span class="line">Clearing the configuration file: ./common/config/ui/private_key.pem</span><br><span class="line">Clearing the configuration file: ./common/config/db/env</span><br><span class="line">Clearing the configuration file: ./common/config/jobservice/env</span><br><span class="line">Clearing the configuration file: ./common/config/jobservice/config.yml</span><br><span class="line">Clearing the configuration file: ./common/config/registry/config.yml</span><br><span class="line">Clearing the configuration file: ./common/config/registry/root.crt</span><br><span class="line">Clearing the configuration file: ./common/config/registryctl/env</span><br><span class="line">Clearing the configuration file: ./common/config/registryctl/config.yml</span><br><span class="line">Clearing the configuration file: ./common/config/nginx/nginx.conf</span><br><span class="line">Clearing the configuration file: ./common/config/log/logrotate.conf</span><br><span class="line">loaded secret from file: /data/secretkey</span><br><span class="line">Generated configuration file: ./common/config/nginx/nginx.conf</span><br><span class="line">Generated configuration file: ./common/config/adminserver/env</span><br><span class="line">Generated configuration file: ./common/config/ui/env</span><br><span class="line">Generated configuration file: ./common/config/registry/config.yml</span><br><span class="line">Generated configuration file: ./common/config/db/env</span><br><span class="line">Generated configuration file: ./common/config/jobservice/env</span><br><span class="line">Generated configuration file: ./common/config/jobservice/config.yml</span><br><span class="line">Generated configuration file: ./common/config/log/logrotate.conf</span><br><span class="line">Generated configuration file: ./common/config/registryctl/env</span><br><span class="line">Generated configuration file: ./common/config/ui/app.conf</span><br><span class="line">Generated certificate, key file: ./common/config/ui/private_key.pem, cert file: ./common/config/registry/root.crt</span><br><span class="line">The configuration files are ready, please use docker-compose to start the service.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[Step 2]: checking existing instance of Harbor ...</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[Step 3]: starting Harbor ...</span><br><span class="line">Creating network &quot;harbor_harbor&quot; with the default driver</span><br><span class="line">Pulling log (goharbor/harbor-log:v1.6.0)...</span><br><span class="line">Trying to pull repository docker.io/goharbor/harbor-log ... </span><br><span class="line">v1.6.0: Pulling from docker.io/goharbor/harbor-log</span><br><span class="line">51be32cd3c9d: Pull complete</span><br><span class="line">fd9cdcfcef45: Pull complete</span><br><span class="line">4167b797c339: Pull complete</span><br><span class="line">b22d11b0e478: Pull complete</span><br><span class="line">d5aad3df7cee: Pull complete</span><br><span class="line">bd43de1bbd44: Pull complete</span><br><span class="line">7494eff3da48: Pull complete</span><br><span class="line">Digest: sha256:27f9e24f28393a6052b71c93b1571f2269e1d3c489f4081996a099ac88ff56ff</span><br><span class="line">Status: Downloaded newer image for docker.io/goharbor/harbor-log:v1.6.0</span><br><span class="line">Pulling postgresql (goharbor/harbor-db:v1.6.0)...</span><br><span class="line">Trying to pull repository docker.io/goharbor/harbor-db ... </span><br><span class="line">v1.6.0: Pulling from docker.io/goharbor/harbor-db</span><br><span class="line">51be32cd3c9d: Already exists</span><br><span class="line">16bdbb239be8: Pull complete</span><br><span class="line">1f2308455a1a: Pull complete</span><br><span class="line">886c09e06dee: Pull complete</span><br><span class="line">4c74f43fb3f6: Pull complete</span><br><span class="line">a5a85370032d: Pull complete</span><br><span class="line">c393ddbdd7fb: Pull complete</span><br><span class="line">ae546b8414b0: Pull complete</span><br><span class="line">Digest: sha256:ee65d512c93860bd4872be296de80c079842a64e2a4002360e720222a87ec346</span><br><span class="line">Status: Downloaded newer image for docker.io/goharbor/harbor-db:v1.6.0</span><br><span class="line">Pulling redis (goharbor/redis-photon:v1.6.0)...</span><br><span class="line">Trying to pull repository docker.io/goharbor/redis-photon ... </span><br><span class="line">v1.6.0: Pulling from docker.io/goharbor/redis-photon</span><br><span class="line">51be32cd3c9d: Already exists</span><br><span class="line">c400e93ba418: Pull complete</span><br><span class="line">170ae129f67d: Pull complete</span><br><span class="line">bffa31ec55cd: Pull complete</span><br><span class="line">5b72a97a5506: Pull complete</span><br><span class="line">Digest: sha256:4095dc26d6331b4d3c25377bc02d95501c51fbba99f31f9761d321bbc17803af</span><br><span class="line">Status: Downloaded newer image for docker.io/goharbor/redis-photon:v1.6.0</span><br><span class="line">Pulling adminserver (goharbor/harbor-adminserver:v1.6.0)...</span><br><span class="line">Trying to pull repository docker.io/goharbor/harbor-adminserver ... </span><br><span class="line">v1.6.0: Pulling from docker.io/goharbor/harbor-adminserver</span><br><span class="line">51be32cd3c9d: Already exists</span><br><span class="line">a12ecf0fa8fc: Pull complete</span><br><span class="line">3757394ad64f: Pull complete</span><br><span class="line">26ceec7e26ff: Pull complete</span><br><span class="line">e8d90789101d: Pull complete</span><br><span class="line">Digest: sha256:c3ca012c2d69099ba4e3bbedc58ffe146fd10aa5129d44cc7d735edf6167959e</span><br><span class="line">Status: Downloaded newer image for docker.io/goharbor/harbor-adminserver:v1.6.0</span><br><span class="line">Pulling registry (goharbor/registry-photon:v2.6.2-v1.6.0)...</span><br><span class="line">Trying to pull repository docker.io/goharbor/registry-photon ... </span><br><span class="line">v2.6.2-v1.6.0: Pulling from docker.io/goharbor/registry-photon</span><br><span class="line">51be32cd3c9d: Already exists</span><br><span class="line">eaf5637d77d9: Pull complete</span><br><span class="line">c68621c7e44d: Pull complete</span><br><span class="line">314e16c23f49: Pull complete</span><br><span class="line">e3f6c59a8a19: Pull complete</span><br><span class="line">e4f08365b84c: Pull complete</span><br><span class="line">29c822b725fa: Pull complete</span><br><span class="line">Digest: sha256:070dcc29fb5b34cdcc982394ead57f598160fd61bd8daee4b2a5f39ea37bd7a0</span><br><span class="line">Status: Downloaded newer image for docker.io/goharbor/registry-photon:v2.6.2-v1.6.0</span><br><span class="line">Pulling ui (goharbor/harbor-ui:v1.6.0)...</span><br><span class="line">Trying to pull repository docker.io/goharbor/harbor-ui ... </span><br><span class="line">v1.6.0: Pulling from docker.io/goharbor/harbor-ui</span><br><span class="line">51be32cd3c9d: Already exists</span><br><span class="line">ec6a6b245304: Pull complete</span><br><span class="line">a88d6c453ccb: Pull complete</span><br><span class="line">d5e2e9e0086a: Pull complete</span><br><span class="line">f8d7e9d8512c: Pull complete</span><br><span class="line">a06b1a705b19: Pull complete</span><br><span class="line">Digest: sha256:de332db437b8df6ce05203247cbf97ac9f4953672a8c22be8858aee47a0f435f</span><br><span class="line">Status: Downloaded newer image for docker.io/goharbor/harbor-ui:v1.6.0</span><br><span class="line">Pulling jobservice (goharbor/harbor-jobservice:v1.6.0)...</span><br><span class="line">Trying to pull repository docker.io/goharbor/harbor-jobservice ... </span><br><span class="line">v1.6.0: Pulling from docker.io/goharbor/harbor-jobservice</span><br><span class="line">51be32cd3c9d: Already exists</span><br><span class="line">ffcdeda0f50f: Pull complete</span><br><span class="line">e69daf7ff175: Pull complete</span><br><span class="line">840fbfb5576e: Pull complete</span><br><span class="line">Digest: sha256:51d2bf14cd9d1bbf082793a0556ff949937655c67569a86424210a1455f60057</span><br><span class="line">Status: Downloaded newer image for docker.io/goharbor/harbor-jobservice:v1.6.0</span><br><span class="line">Pulling proxy (goharbor/nginx-photon:v1.6.0)...</span><br><span class="line">Trying to pull repository docker.io/goharbor/nginx-photon ... </span><br><span class="line">v1.6.0: Pulling from docker.io/goharbor/nginx-photon</span><br><span class="line">51be32cd3c9d: Already exists</span><br><span class="line">edc138fa5ed7: Pull complete</span><br><span class="line">Digest: sha256:3270c6fc3bdaaecd16280592e916e2cfcf7c5eb54ffc46d79b507b625e3fb4c6</span><br><span class="line">Status: Downloaded newer image for docker.io/goharbor/nginx-photon:v1.6.0</span><br><span class="line">Creating harbor-log ... done</span><br><span class="line">Creating redis              ... done</span><br><span class="line">Creating harbor-adminserver ... done</span><br><span class="line">Creating registry           ... done</span><br><span class="line">Creating harbor-db          ... done</span><br><span class="line">Creating harbor-ui          ... done</span><br><span class="line">Creating harbor-jobservice  ... done</span><br><span class="line">Creating nginx              ... done</span><br><span class="line"></span><br><span class="line">✔ ----Harbor has been installed and started successfully.----</span><br><span class="line"></span><br><span class="line">Now you should be able to visit the admin portal at http://192.168.2.46 . </span><br><span class="line">For more details, please visit https://github.com/goharbor/harbor .</span><br></pre></td></tr></table></figure><h4 id="5-3-使用harbor"><a href="#5-3-使用harbor" class="headerlink" title="5.3 使用harbor"></a>5.3 使用harbor</h4><blockquote><p>web访问：<a href="http://192.168.2.46" target="_blank" rel="noopener">http://192.168.2.46</a> 客户端若使用harbor仓库则需进行如下配置<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#修改配置文件</span><br><span class="line">[root@localhost ~]# cat /etc/docker/daemon.json </span><br><span class="line">&#123;</span><br><span class="line">  &quot;registry-mirrors&quot;: [&quot;https://docker.mirrors.ustc.edu.cn&quot;],</span><br><span class="line">  &quot;insecure-registries&quot;: [&quot;192.168.2.46&quot;]</span><br><span class="line">&#125;</span><br><span class="line">#重启docker服务</span><br><span class="line">[root@localhost ~]# systemctl restart docker</span><br></pre></td></tr></table></figure></p></blockquote><h5 id="5-3-1-push镜像至harbor中"><a href="#5-3-1-push镜像至harbor中" class="headerlink" title="5.3.1 push镜像至harbor中"></a>5.3.1 push镜像至harbor中</h5><h6 id="5-3-1-1-登陆"><a href="#5-3-1-1-登陆" class="headerlink" title="5.3.1.1 登陆"></a>5.3.1.1 登陆</h6><center> <img src="https://i.loli.net/2018/10/23/5bcea9c0e6928.png" alt="03.png" title="03.png"> </center><h6 id="5-3-1-2-push镜像"><a href="#5-3-1-2-push镜像" class="headerlink" title="5.3.1.2 push镜像"></a>5.3.1.2 push镜像</h6><p>若为从其他地方pull的镜像需要修改tag<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker tag centos:latest 192.168.2.46/library/centos:latest</span><br><span class="line">docker push 192.168.2.46/library/centos:latest</span><br></pre></td></tr></table></figure></p><h5 id="5-3-2-客户端pull镜像"><a href="#5-3-2-客户端pull镜像" class="headerlink" title="5.3.2 客户端pull镜像"></a>5.3.2 客户端pull镜像</h5><h6 id="5-3-2-1-客户端从服务器中拉取镜像"><a href="#5-3-2-1-客户端从服务器中拉取镜像" class="headerlink" title="5.3.2.1 客户端从服务器中拉取镜像"></a>5.3.2.1 客户端从服务器中拉取镜像</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">命令如下：docker pull 192.168.2.46/library/zabbix2.4.8:v1.0</span><br></pre></td></tr></table></figure><center> <img src="https://i.loli.net/2018/10/23/5bcea8312b5c5.png" alt="01.png" title="01.png"> </center><h6 id="5-3-2-2-查看此客户端的镜像"><a href="#5-3-2-2-查看此客户端的镜像" class="headerlink" title="5.3.2.2 查看此客户端的镜像"></a>5.3.2.2 查看此客户端的镜像</h6><center> <img src="https://i.loli.net/2018/10/23/5bcea831655f6.png" alt="02.png" title="02.png"></center><h3 id="6-常见错误："><a href="#6-常见错误：" class="headerlink" title="6 常见错误："></a>6 常见错误：</h3><h4 id="6-1-问题1："><a href="#6-1-问题1：" class="headerlink" title="6.1 问题1："></a>6.1 问题1：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#问题描述：</span><br><span class="line">使用systemctl start sshd 执行报错Failed to get D-Bus connection: Operation not permitted解决</span><br><span class="line">#解决方法：</span><br><span class="line">启动容器时需要使用docker run -tdi --privileged centos /usr/sbin/init，这样就不能使用docker attach进入容器操作命令了，需要使用docker exec -it zabbix-server /bin/bash</span><br></pre></td></tr></table></figure><p>docker run -itd –restart=always -v /etc/sftp.conf:/etc/sftp/users.conf:ro -v /mvtech/sftp_root:/home –privileged -p 3333:22 –name=sftp docker.io/atmoz/sftp</p><h3 id="制作图片视频程序镜像"><a href="#制作图片视频程序镜像" class="headerlink" title="制作图片视频程序镜像"></a>制作图片视频程序镜像</h3><p>docker run -itd –restart=always –network host  –privileged –name=pic 211.103.227.138:24980/library/centos7_zh_jdk8 /usr/sbin/init<br>-v /mvtech/picsort /mvtech/picsort </p><p>cd /mvtech/python/check_text &amp;&amp; python3 check_text.py &amp;<br>cd /mvtech/python/check_text &amp;&amp; python3 check_text.py &amp;<br>cd /mvtech/python/picscanner180228 &amp;&amp; python monitor_image.py &amp;<br>python3 check_text.py &amp;[</p><p>docker run -itd –restart=always -v /mvtech/picsort /mvtech/picsort –privileged –name=pic 211.103.227.138:24980/mvtech/pic /usr/sbin/init<br>-v /mvtech/picsort /mvtech/picsort </p><p> docker run -d -it –name=”eu_wz” –hostname=”EU-WZ” –memory=”40960m” –mac-address=”aa:bb:cc:04:28:01” –memory-swap=”-1” –env=”LANG=en_US.UTF-8” –env=”JAVA_HOME=/mvtech/apps/java” –env=”JRE_HOME=/mvtech/apps/java/jre” –env=”CLASSPATH=/mvtech/apps/java/lib:/mvtech/apps/java/jre/lib” –env=”PATH=/mvtech/apps/java/bin:/mvtech/apps/java/jre/bin:/mvtech/apps/java:/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin:/root/bin” –volume=”/etc/localtime:/etc/localtime:ro” –volume=”/mvtech/apps/java:/mvtech/apps/java:ro” –volume=”/mvtech/apps/docker/eu_wz:/mvtech/apps/isms-backend:ro” –volume=”/mvtech/data/vsftp/eu_wz/:/mvtech/data” –volume=”/mvtech/work/docker/eu_wz/:/mvtech/work” –volume=”/mvtech/logs/docker/eu_wz/:/mvtech/logs” –workdir=”/mvtech” isms-backend:1.0 /bin/bash</p>]]></content>
      
      
      
        <tags>
            
            <tag> docker </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>MHA入门实战</title>
      <link href="/2018/12/18/MHA%E5%85%A5%E9%97%A8%E5%AE%9E%E6%88%98/"/>
      <url>/2018/12/18/MHA%E5%85%A5%E9%97%A8%E5%AE%9E%E6%88%98/</url>
      
        <content type="html"><![CDATA[<h1 id="1-介绍"><a href="#1-介绍" class="headerlink" title="1 介绍"></a>1 介绍</h1><h2 id="1-1-原理介绍"><a href="#1-1-原理介绍" class="headerlink" title="1.1 原理介绍"></a>1.1 原理介绍</h2><blockquote><p>MHA（Master High Availability）目前在MySQL高可用方面是一个相对成熟的解决方案，它由日本DeNA公司youshimaton（现就职于Facebook公司）开发，是一套优秀的作为MySQL高可用性环境下故障切换和主从提升的高可用软件。在MySQL故障切换过程中，MHA能做到在0~30秒之内自动完成数据库的故障切换操作，并且在进行故障切换的过程中，MHA能在最大程度上保证数据的一致性，以达到真正意义上的高可用。</p></blockquote><h3 id="1-1-2-mha集群架构图"><a href="#1-1-2-mha集群架构图" class="headerlink" title="1.1.2 mha集群架构图"></a>1.1.2 mha集群架构图</h3><center> <img src="https://i.loli.net/2018/11/23/5bf797dc1ecf6.png" alt="mha.png" title="mha.png"></center><h3 id="1-1-3-工作原理"><a href="#1-1-3-工作原理" class="headerlink" title="1.1.3 工作原理"></a>1.1.3 工作原理</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1.从宕机崩溃的master保存二进制日志事件（binlog events）;</span><br><span class="line">2.识别含有最新更新的slave；</span><br><span class="line">3.应用差异的中继日志（relay log）到其他的slave；</span><br><span class="line">4.应用从master保存的二进制日志事件（binlog events）；</span><br><span class="line">5.提升一个slave为新的master；</span><br><span class="line">6.使其他的slave连接新的master进行复制；</span><br></pre></td></tr></table></figure><h2 id="1-2-软件构成"><a href="#1-2-软件构成" class="headerlink" title="1.2 软件构成"></a>1.2 软件构成</h2><blockquote><p>MHA软件由两部分组成，Manager工具包和Node工具包，具体的说明如下。</p></blockquote><h3 id="1-2-1-Manager工具包"><a href="#1-2-1-Manager工具包" class="headerlink" title="1.2.1 Manager工具包"></a>1.2.1 Manager工具包</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">masterha_check_ssh              检查MHA的SSH配置状况</span><br><span class="line">masterha_check_repl             检查MySQL复制状况</span><br><span class="line">masterha_manger                 启动MHA</span><br><span class="line">masterha_check_status           检测当前MHA运行状态</span><br><span class="line">masterha_master_monitor         检测master是否宕机</span><br><span class="line">masterha_master_switch          控制故障转移（自动或者手动）</span><br><span class="line">masterha_conf_host              添加或删除配置的server信息</span><br></pre></td></tr></table></figure><h3 id="1-2-2-Node工具包"><a href="#1-2-2-Node工具包" class="headerlink" title="1.2.2 Node工具包"></a>1.2.2 Node工具包</h3><blockquote><p>这些工具通常由MHA Manager的脚本触发，无需人为操作<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">save_binary_logs                保存和复制master的二进制日志</span><br><span class="line">apply_diff_relay_logs           识别差异的中继日志事件并将其差异的事件应用于其他的slave</span><br><span class="line">filter_mysqlbinlog              去除不必要的ROLLBACK事件（MHA已不再使用这个工具）</span><br><span class="line">purge_relay_logs                清除中继日志（不会阻塞SQL线程）</span><br></pre></td></tr></table></figure></p></blockquote><h2 id="1-3-参考地址"><a href="#1-3-参考地址" class="headerlink" title="1.3 参考地址"></a>1.3 参考地址</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/yoshinorim/mha4mysql-manager/wiki/Installation</span><br><span class="line">http://www.cnblogs.com/gomysql/p/3675429.html</span><br></pre></td></tr></table></figure><h1 id="2-部署规划"><a href="#2-部署规划" class="headerlink" title="2 部署规划"></a>2 部署规划</h1><blockquote><p>本次部署准备三台服务器，一台master，一台备用master，一台slave；vip的产生使用keepalived（之前使用过ifconfig添加vip，但有的时候能够ping通有的时候不通，因此换成keepalived）</p></blockquote><h2 id="2-1-部署规划"><a href="#2-1-部署规划" class="headerlink" title="2.1 部署规划"></a>2.1 部署规划</h2><table><thead><tr><th>序号</th><th>服务器主机名</th><th>服务器IP</th><th>mha角色</th><th>用途</th><th>需要安装软件</th></tr></thead><tbody><tr><td>1</td><td>node71</td><td>192.168.2.71</td><td>mha-manager+mha-node</td><td>slave+mha-manager</td><td>mysql+mha4mysql-node+mha4mysql-manager</td></tr><tr><td>2</td><td>node72</td><td>192.168.2.72</td><td>mha-node</td><td>备用master节点</td><td>mysql+mha4mysql-node+keepalived</td></tr><tr><td>3</td><td>node73</td><td>192.168.2.73</td><td>mha-node</td><td>master节点</td><td>mysql+mha4mysql-node +keepalived</td></tr></tbody></table><h2 id="2-2-yum源配置"><a href="#2-2-yum源配置" class="headerlink" title="2.2 yum源配置"></a>2.2 yum源配置</h2><blockquote><p>若服务器能联网请添加阿里云epel.repo镜像源和mysql5.6源，若不能联网，需将需要的包下载下来自制yum源；生产环境很多不能连接互联网，可在一台可联网的测试机上配置epel源，通过yum install –downloadonly –downloaddir=/root/mha/ perl-Parallel-ForkManager perl-DBD-MySQL perl-Config-Tiny perl-Log-Dispatch mysql-community-server，下载到本地，通过createrepo创建yum源</p></blockquote><h2 id="2-3-安装包和相关脚本获取"><a href="#2-3-安装包和相关脚本获取" class="headerlink" title="2.3 安装包和相关脚本获取"></a>2.3 安装包和相关脚本获取</h2><blockquote><p>文件存放在百度网盘中，链接：<a href="https://pan.baidu.com/s/12jqvyr_fM9qZTdP3sAbDFg" target="_blank" rel="noopener">https://pan.baidu.com/s/12jqvyr_fM9qZTdP3sAbDFg</a> 提取码：t2jv </p></blockquote><table><thead><tr><th>序号</th><th>文件名称</th><th>文件用途</th></tr></thead><tbody><tr><td>1</td><td>app1.conf</td><td>mha-manager配置文件</td></tr><tr><td>2</td><td>install_mysql5.6.sh</td><td>脚本自动安装初始化mysql5.6</td></tr><tr><td>3</td><td>master_ip_failover</td><td>故障切换masterip脚本</td></tr><tr><td>4</td><td>master_ip_online_change</td><td>在线切换masterip脚本</td></tr><tr><td>5</td><td>mha4mysql-manager-0.57-0.el7.noarch.rpm</td><td>mha-manager rpm安装包</td></tr><tr><td>6</td><td>mha4mysql-node-0.57-0.el7.noarch.rpm</td><td>mha-node rpm安装包</td></tr><tr><td>7</td><td>send_report</td><td>切换ip发送邮件脚本</td></tr><tr><td>8</td><td>keepalived.conf</td><td>产生vip的配置文件</td></tr><tr><td>9</td><td>purge_relay_log.sh</td><td>自动删除relay日志脚本</td></tr><tr><td>10</td><td>mha4mysql-node-0.57.tar.gz</td><td>mha-node 源码安装包</td></tr><tr><td>11</td><td>mha4mysql-manager-0.57.tar.gz</td><td>mha-manager 源码安装包</td></tr></tbody></table><h2 id="2-4-操作系统环境"><a href="#2-4-操作系统环境" class="headerlink" title="2.4 操作系统环境"></a>2.4 操作系统环境</h2><blockquote><p>本次测试环境为centos7.4最小化安装，服务器可以访问外网</p></blockquote><h1 id="3-部署集群"><a href="#3-部署集群" class="headerlink" title="3 部署集群"></a>3 部署集群</h1><h2 id="3-1-安装mysql"><a href="#3-1-安装mysql" class="headerlink" title="3.1 安装mysql"></a>3.1 安装mysql</h2><blockquote><p>使用脚本完成mysql的部署，脚本使用yum进行安装，并完成相应的初始化.<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bash +x install_mysql5.6.sh</span><br><span class="line"><span class="comment"># 脚本执行完毕后mysql用户：root 密码：mvtech123</span></span><br></pre></td></tr></table></figure></p></blockquote><h2 id="3-2-配置主从复制"><a href="#3-2-配置主从复制" class="headerlink" title="3.2 配置主从复制"></a>3.2 配置主从复制</h2><blockquote><p>配置成一主多从架构<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">1 添加主从复制账户</span><br><span class="line">    <span class="keyword">grant</span> <span class="keyword">replication</span> <span class="keyword">slave</span> <span class="keyword">on</span> *.* <span class="keyword">to</span> repl@<span class="string">'192.168.2.%'</span> <span class="keyword">identified</span> <span class="keyword">by</span> <span class="string">'slave'</span>;</span><br><span class="line">2 添加mha管理账号，每台都添加</span><br><span class="line">    <span class="keyword">grant</span> all <span class="keyword">privileges</span> <span class="keyword">on</span> *.* <span class="keyword">to</span> root@<span class="string">"%"</span> <span class="keyword">identified</span> <span class="keyword">by</span> <span class="string">"mvtech123"</span>;()</span><br><span class="line">    <span class="keyword">grant</span> all <span class="keyword">privileges</span> <span class="keyword">on</span> *.* <span class="keyword">to</span> masterha@<span class="string">"%"</span> <span class="keyword">identified</span> <span class="keyword">by</span> <span class="string">"masterha"</span>;(注：本次配置文件里设置的是root账号)</span><br><span class="line">3 查看主库binlog日志</span><br><span class="line">    <span class="keyword">show</span> <span class="built_in">binary</span> <span class="keyword">logs</span></span><br><span class="line"><span class="number">4</span> 从库配置主从</span><br><span class="line">    <span class="keyword">CHANGE</span> <span class="keyword">MASTER</span> <span class="keyword">TO</span> MASTER_HOST=<span class="string">'192.168.2.72'</span>,</span><br><span class="line">    MASTER_USER=<span class="string">'repl'</span>,</span><br><span class="line">    MASTER_PASSWORD=<span class="string">'slave'</span>,</span><br><span class="line">    MASTER_LOG_FILE=<span class="string">'mysql-bin.000004'</span>,</span><br><span class="line">    MASTER_LOG_POS=<span class="number">533</span>;</span><br><span class="line">5 从库启动slave</span><br><span class="line">    <span class="keyword">start</span> <span class="keyword">slave</span>;</span><br><span class="line">6 查看从库主从复制状态</span><br><span class="line">    <span class="keyword">show</span> <span class="keyword">slave</span> <span class="keyword">status</span>;</span><br><span class="line">7 slave执行：</span><br><span class="line"><span class="keyword">set</span> <span class="keyword">global</span> relay_log_purge=<span class="number">0</span>;(此处我已添加到脚本里，不用每次都执行)</span><br><span class="line"><span class="keyword">set</span> <span class="keyword">global</span> read_only=<span class="number">1</span>;</span><br></pre></td></tr></table></figure></p></blockquote><h2 id="3-3-配置mha集群"><a href="#3-3-配置mha集群" class="headerlink" title="3.3 配置mha集群"></a>3.3 配置mha集群</h2><h3 id="3-3-1-配置各个节点之间的主机互信"><a href="#3-3-1-配置各个节点之间的主机互信" class="headerlink" title="3.3.1 配置各个节点之间的主机互信"></a>3.3.1 配置各个节点之间的主机互信</h3><blockquote><p>本次使用ansible快速配置，具体ansible的配置在此不做赘述。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">-- 各服务器执行ssh-keygen</span><br><span class="line">ansible mha -m shell -a <span class="string">"ssh-keygen -t rsa -P '' -f ~/.ssh/id_rsa"</span> -f 100</span><br><span class="line">-- 生成authorized_keys文件</span><br><span class="line">ansible mha -m shell -a <span class="string">"cat /root/.ssh/id_rsa.pub"</span> -f 100 &gt; /tmp/authorized_keys</span><br><span class="line">-- 去除多余的行</span><br><span class="line">sed -i <span class="string">'/SUCCESS/d'</span> /tmp/authorized_keys</span><br><span class="line">-- 分发authorized_keys至每台服务器</span><br><span class="line">ansible mha -m copy -a <span class="string">"src=/tmp/authorized_keys dest=/root/.ssh/ owner=root group=root mode=0644"</span> -f 100</span><br></pre></td></tr></table></figure></p></blockquote><h3 id="3-3-1-配置node节点"><a href="#3-3-1-配置node节点" class="headerlink" title="3.3.1 配置node节点"></a>3.3.1 配置node节点</h3><blockquote><p>node节点是除了manager角色以外的节点，此次试验为,node72，node73<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#安装依赖包</span><br><span class="line">yum install perl-DBD-MySQL</span><br><span class="line">#安装node rpm包</span><br><span class="line">rpm -ivh mha4mysql-node-0.57-0.el7.noarch.rpm</span><br></pre></td></tr></table></figure></p></blockquote><blockquote><p>master节点和备用master节点需要配置keepalived来配置vip<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">1 安装</span><br><span class="line">yum install keepalived -y</span><br><span class="line">2 编辑配置文件/etc/keepalived/keepalived.conf(注：由于两台不同时启动，因此配置文件可以设置成一样)</span><br><span class="line">! Configuration File <span class="keyword">for</span> keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">router_id LVS_DEVEL</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">state BACKUP</span><br><span class="line">interface ens3</span><br><span class="line">virtual_router_id 30</span><br><span class="line">priority 90</span><br><span class="line">advert_int 1</span><br><span class="line">nopreempt</span><br><span class="line">authentication &#123;</span><br><span class="line">auth_type PASS</span><br><span class="line">auth_pass 11111</span><br><span class="line">&#125;</span><br><span class="line">virtual_ipaddress &#123;</span><br><span class="line">192.168.2.74</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p></blockquote><h3 id="3-3-2-配置manager节点"><a href="#3-3-2-配置manager节点" class="headerlink" title="3.3.2 配置manager节点"></a>3.3.2 配置manager节点</h3><h4 id="3-3-2-1-安装"><a href="#3-3-2-1-安装" class="headerlink" title="3.3.2.1 安装"></a>3.3.2.1 安装</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#安装依赖包</span></span><br><span class="line">yum install perl-Parallel-ForkManager perl-DBD-MySQL perl-Config-Tiny perl-Log-Dispatch</span><br><span class="line"><span class="comment">#安装manager和node rpm包</span></span><br><span class="line">rpm -ivh mha4mysql-node-0.57-0.el7.noarch.rpm</span><br><span class="line">rpm -ivh mha4mysql-manager-0.57-0.el7.noarch.rpm</span><br><span class="line"><span class="comment">#创建文件夹</span></span><br><span class="line"><span class="comment">#存放mha-manager配置文件文件夹</span></span><br><span class="line">mkdir -p /etc/masterha</span><br><span class="line"><span class="comment">#创建日志文件夹</span></span><br><span class="line">mkdir -p /var/<span class="built_in">log</span>/masterha/app1</span><br></pre></td></tr></table></figure><h4 id="3-3-2-2-修改配置文件"><a href="#3-3-2-2-修改配置文件" class="headerlink" title="3.3.2.2 修改配置文件"></a>3.3.2.2 修改配置文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[server default]</span><br><span class="line">manager_log=/var/<span class="built_in">log</span>/masterha/app1/manager.log</span><br><span class="line">manager_workdir=/var/<span class="built_in">log</span>/masterha/app1</span><br><span class="line">master_binlog_dir=/mvtech/mysql/logs</span><br><span class="line">master_ip_failover_script=/usr/<span class="built_in">local</span>/bin/master_ip_failover</span><br><span class="line">master_ip_online_change_script=/usr/<span class="built_in">local</span>/bin/master_ip_online_change</span><br><span class="line">user=root</span><br><span class="line">password=mvtech123</span><br><span class="line">ping_interval=1</span><br><span class="line">remote_workdir=/tmp</span><br><span class="line">repl_password=slave</span><br><span class="line">repl_user=repl</span><br><span class="line">report_script=/usr/<span class="built_in">local</span>/bin/send_report</span><br><span class="line">secondary_check_script=/usr/bin/masterha_secondary_check -s node72 -s node71</span><br><span class="line">ssh_user=root</span><br><span class="line"></span><br><span class="line">[server1]</span><br><span class="line">hostname=node73</span><br><span class="line"></span><br><span class="line">[server2]</span><br><span class="line">candidate_master=1</span><br><span class="line">hostname=node72</span><br><span class="line">port=3306</span><br><span class="line"></span><br><span class="line">[server3]</span><br><span class="line">hostname=node71</span><br><span class="line">port=3306</span><br></pre></td></tr></table></figure><h4 id="3-3-2-3-创建相应脚本-脚本需要有可执行权限"><a href="#3-3-2-3-创建相应脚本-脚本需要有可执行权限" class="headerlink" title="3.3.2.3 创建相应脚本,脚本需要有可执行权限"></a>3.3.2.3 创建相应脚本,脚本需要有可执行权限</h4><blockquote><p>/usr/local/bin/master_ip_failover<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env perl</span></span><br><span class="line"></span><br><span class="line">use strict;</span><br><span class="line">use warnings FATAL =&gt; <span class="string">'all'</span>;</span><br><span class="line"></span><br><span class="line">use Getopt::Long;</span><br><span class="line"></span><br><span class="line">my (</span><br><span class="line">    <span class="variable">$command</span>,          <span class="variable">$ssh_user</span>,        <span class="variable">$orig_master_host</span>, <span class="variable">$orig_master_ip</span>,</span><br><span class="line">    <span class="variable">$orig_master_port</span>, <span class="variable">$new_master_host</span>, <span class="variable">$new_master_ip</span>,    <span class="variable">$new_master_port</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">my <span class="variable">$vip</span> = <span class="string">'192.168.2.74/24'</span>;</span><br><span class="line">my <span class="variable">$key</span> = <span class="string">'1'</span>;</span><br><span class="line">my <span class="variable">$ssh_start_vip</span> = <span class="string">"/bin/systemctl start keepalived"</span>;</span><br><span class="line">my <span class="variable">$ssh_stop_vip</span> = <span class="string">"/bin/systemctl stop keepalived"</span>;</span><br><span class="line"></span><br><span class="line">GetOptions(</span><br><span class="line">    <span class="string">'command=s'</span>          =&gt; \<span class="variable">$command</span>,</span><br><span class="line">    <span class="string">'ssh_user=s'</span>         =&gt; \<span class="variable">$ssh_user</span>,</span><br><span class="line">    <span class="string">'orig_master_host=s'</span> =&gt; \<span class="variable">$orig_master_host</span>,</span><br><span class="line">    <span class="string">'orig_master_ip=s'</span>   =&gt; \<span class="variable">$orig_master_ip</span>,</span><br><span class="line">    <span class="string">'orig_master_port=i'</span> =&gt; \<span class="variable">$orig_master_port</span>,</span><br><span class="line">    <span class="string">'new_master_host=s'</span>  =&gt; \<span class="variable">$new_master_host</span>,</span><br><span class="line">    <span class="string">'new_master_ip=s'</span>    =&gt; \<span class="variable">$new_master_ip</span>,</span><br><span class="line">    <span class="string">'new_master_port=i'</span>  =&gt; \<span class="variable">$new_master_port</span>,</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="built_in">exit</span> &amp;main();</span><br><span class="line"></span><br><span class="line">sub main &#123;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span> <span class="string">"\n\nIN SCRIPT TEST====<span class="variable">$ssh_stop_vip</span>==<span class="variable">$ssh_start_vip</span>===\n\n"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( <span class="variable">$command</span> eq <span class="string">"stop"</span> || <span class="variable">$command</span> eq <span class="string">"stopssh"</span> ) &#123;</span><br><span class="line"></span><br><span class="line">        my <span class="variable">$exit_code</span> = 1;</span><br><span class="line">        <span class="built_in">eval</span> &#123;</span><br><span class="line">            <span class="built_in">print</span> <span class="string">"Disabling the VIP on old master: <span class="variable">$orig_master_host</span> \n"</span>;</span><br><span class="line">            &amp;stop_vip();</span><br><span class="line">            <span class="variable">$exit_code</span> = 0;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$@</span>) &#123;</span><br><span class="line">            warn <span class="string">"Got Error: <span class="variable">$@</span>\n"</span>;</span><br><span class="line">            <span class="built_in">exit</span> <span class="variable">$exit_code</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">exit</span> <span class="variable">$exit_code</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    elsif ( <span class="variable">$command</span> eq <span class="string">"start"</span> ) &#123;</span><br><span class="line"></span><br><span class="line">        my <span class="variable">$exit_code</span> = 10;</span><br><span class="line">        <span class="built_in">eval</span> &#123;</span><br><span class="line">            <span class="built_in">print</span> <span class="string">"Enabling the VIP - <span class="variable">$vip</span> on the new master - <span class="variable">$new_master_host</span> \n"</span>;</span><br><span class="line">            &amp;start_vip();</span><br><span class="line">            <span class="variable">$exit_code</span> = 0;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable">$@</span>) &#123;</span><br><span class="line">            warn <span class="variable">$@</span>;</span><br><span class="line">            <span class="built_in">exit</span> <span class="variable">$exit_code</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">exit</span> <span class="variable">$exit_code</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    elsif ( <span class="variable">$command</span> eq <span class="string">"status"</span> ) &#123;</span><br><span class="line">        <span class="built_in">print</span> <span class="string">"Checking the Status of the script.. OK \n"</span>;</span><br><span class="line">        <span class="built_in">exit</span> 0;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        &amp;usage();</span><br><span class="line">        <span class="built_in">exit</span> 1;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">sub <span class="function"><span class="title">start_vip</span></span>() &#123;</span><br><span class="line">    `ssh <span class="variable">$ssh_user</span>\@<span class="variable">$new_master_host</span> \<span class="string">" <span class="variable">$ssh_start_vip</span> \"`;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">sub stop_vip() &#123;</span></span><br><span class="line"><span class="string">     return 0  unless  (<span class="variable">$ssh_user</span>);</span></span><br><span class="line"><span class="string">    `ssh <span class="variable">$ssh_user</span>\@<span class="variable">$orig_master_host</span> \" <span class="variable">$ssh_stop_vip</span> \"`;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">sub usage &#123;</span></span><br><span class="line"><span class="string">    print</span></span><br><span class="line"><span class="string">    "</span>Usage: master_ip_failover --<span class="built_in">command</span>=start|stop|stopssh|status --orig_master_host=host --orig_master_ip=ip --orig_master_port=port --new_master_host=host --new_master_ip=ip --new_master_port=port\n<span class="string">";</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure></p></blockquote><blockquote><p>/usr/local/bin/master_ip_online_change 在线切换master的ip<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env perl</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  Copyright (C) 2011 DeNA Co.,Ltd.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#  This program is free software; you can redistribute it and/or modify</span></span><br><span class="line"><span class="comment">#  it under the terms of the GNU General Public License as published by</span></span><br><span class="line"><span class="comment">#  the Free Software Foundation; either version 2 of the License, or</span></span><br><span class="line"><span class="comment">#  (at your option) any later version.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#  This program is distributed in the hope that it will be useful,</span></span><br><span class="line"><span class="comment">#  but WITHOUT ANY WARRANTY; without even the implied warranty of</span></span><br><span class="line"><span class="comment">#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span></span><br><span class="line"><span class="comment">#  GNU General Public License for more details.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#  You should have received a copy of the GNU General Public License</span></span><br><span class="line"><span class="comment">#   along with this program; if not, write to the Free Software</span></span><br><span class="line"><span class="comment">#  Foundation, Inc.,</span></span><br><span class="line"><span class="comment">#  51 Franklin Street, Fifth Floor, Boston, MA  02110-1301  USA</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## <span class="doctag">Note:</span> This is a sample script and is not complete. Modify the script based on your environment.</span></span><br><span class="line"></span><br><span class="line">use strict;</span><br><span class="line">use warnings FATAL =&gt; <span class="string">'all'</span>;</span><br><span class="line"></span><br><span class="line">use Getopt::Long;</span><br><span class="line">use MHA::DBHelper;</span><br><span class="line">use MHA::NodeUtil;</span><br><span class="line">use Time::HiRes qw( sleep gettimeofday tv_interval );</span><br><span class="line">use Data::Dumper;</span><br><span class="line"></span><br><span class="line">my <span class="variable">$_tstart</span>;</span><br><span class="line">my <span class="variable">$_running_interval</span> = 0.1;</span><br><span class="line">my (</span><br><span class="line">  <span class="variable">$command</span>,          <span class="variable">$orig_master_host</span>, <span class="variable">$orig_master_ip</span>,</span><br><span class="line">  <span class="variable">$orig_master_port</span>, <span class="variable">$orig_master_user</span>, </span><br><span class="line">  <span class="variable">$new_master_host</span>,  <span class="variable">$new_master_ip</span>,    <span class="variable">$new_master_port</span>,</span><br><span class="line">  <span class="variable">$new_master_user</span>,  </span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">my <span class="variable">$vip</span> = <span class="string">'192.168.2.74/24'</span>;  <span class="comment"># Virtual IP </span></span><br><span class="line">my <span class="variable">$key</span> = <span class="string">"1"</span>; </span><br><span class="line">my <span class="variable">$ssh_start_vip</span> = <span class="string">"/bin/systemctl start keepalived"</span>;</span><br><span class="line">my <span class="variable">$ssh_stop_vip</span> = <span class="string">"/bin/systemctl stop keepalived"</span>;</span><br><span class="line">my <span class="variable">$ssh_user</span> = <span class="string">"root"</span>;</span><br><span class="line">my <span class="variable">$new_master_password</span>=<span class="string">'mvtech123'</span>;</span><br><span class="line">my <span class="variable">$orig_master_password</span>=<span class="string">'mvtech123'</span>;</span><br><span class="line">GetOptions(</span><br><span class="line">  <span class="string">'command=s'</span>              =&gt; \<span class="variable">$command</span>,</span><br><span class="line">  <span class="comment">#'ssh_user=s'             =&gt; \$ssh_user,  </span></span><br><span class="line">  <span class="string">'orig_master_host=s'</span>     =&gt; \<span class="variable">$orig_master_host</span>,</span><br><span class="line">  <span class="string">'orig_master_ip=s'</span>       =&gt; \<span class="variable">$orig_master_ip</span>,</span><br><span class="line">  <span class="string">'orig_master_port=i'</span>     =&gt; \<span class="variable">$orig_master_port</span>,</span><br><span class="line">  <span class="string">'orig_master_user=s'</span>     =&gt; \<span class="variable">$orig_master_user</span>,</span><br><span class="line">  <span class="comment">#'orig_master_password=s' =&gt; \$orig_master_password,</span></span><br><span class="line">  <span class="string">'new_master_host=s'</span>      =&gt; \<span class="variable">$new_master_host</span>,</span><br><span class="line">  <span class="string">'new_master_ip=s'</span>        =&gt; \<span class="variable">$new_master_ip</span>,</span><br><span class="line">  <span class="string">'new_master_port=i'</span>      =&gt; \<span class="variable">$new_master_port</span>,</span><br><span class="line">  <span class="string">'new_master_user=s'</span>      =&gt; \<span class="variable">$new_master_user</span>,</span><br><span class="line">  <span class="comment">#'new_master_password=s'  =&gt; \$new_master_password,</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="built_in">exit</span> &amp;main();</span><br><span class="line"></span><br><span class="line">sub current_time_us &#123;</span><br><span class="line">  my ( <span class="variable">$sec</span>, <span class="variable">$microsec</span> ) = gettimeofday();</span><br><span class="line">  my <span class="variable">$curdate</span> = localtime(<span class="variable">$sec</span>);</span><br><span class="line">  <span class="built_in">return</span> <span class="variable">$curdate</span> . <span class="string">" "</span> . sprintf( <span class="string">"%06d"</span>, <span class="variable">$microsec</span> );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">sub sleep_until &#123;</span><br><span class="line">  my <span class="variable">$elapsed</span> = tv_interval(<span class="variable">$_tstart</span>);</span><br><span class="line">  <span class="keyword">if</span> ( <span class="variable">$_running_interval</span> &gt; <span class="variable">$elapsed</span> ) &#123;</span><br><span class="line">    sleep( <span class="variable">$_running_interval</span> - <span class="variable">$elapsed</span> );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">sub get_threads_util &#123;</span><br><span class="line">  my <span class="variable">$dbh</span>                    = <span class="built_in">shift</span>;</span><br><span class="line">  my <span class="variable">$my_connection_id</span>       = <span class="built_in">shift</span>;</span><br><span class="line">  my <span class="variable">$running_time_threshold</span> = <span class="built_in">shift</span>;</span><br><span class="line">  my <span class="variable">$type</span>                   = <span class="built_in">shift</span>;</span><br><span class="line">  <span class="variable">$running_time_threshold</span> = 0 unless (<span class="variable">$running_time_threshold</span>);</span><br><span class="line">  <span class="variable">$type</span>                   = 0 unless (<span class="variable">$type</span>);</span><br><span class="line">  my @threads;</span><br><span class="line"></span><br><span class="line">  my <span class="variable">$sth</span> = <span class="variable">$dbh</span>-&gt;prepare(<span class="string">"SHOW PROCESSLIST"</span>);</span><br><span class="line">  <span class="variable">$sth</span>-&gt;execute();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> ( my <span class="variable">$ref</span> = <span class="variable">$sth</span>-&gt;fetchrow_hashref() ) &#123;</span><br><span class="line">    my <span class="variable">$id</span>         = <span class="variable">$ref</span>-&gt;&#123;Id&#125;;</span><br><span class="line">    my <span class="variable">$user</span>       = <span class="variable">$ref</span>-&gt;&#123;User&#125;;</span><br><span class="line">    my <span class="variable">$host</span>       = <span class="variable">$ref</span>-&gt;&#123;Host&#125;;</span><br><span class="line">    my <span class="variable">$command</span>    = <span class="variable">$ref</span>-&gt;&#123;Command&#125;;</span><br><span class="line">    my <span class="variable">$state</span>      = <span class="variable">$ref</span>-&gt;&#123;State&#125;;</span><br><span class="line">    my <span class="variable">$query_time</span> = <span class="variable">$ref</span>-&gt;&#123;Time&#125;;</span><br><span class="line">    my <span class="variable">$info</span>       = <span class="variable">$ref</span>-&gt;&#123;Info&#125;;</span><br><span class="line">    <span class="variable">$info</span> =~ s/^\s*(.*?)\s*$/<span class="variable">$1</span>/ <span class="keyword">if</span> defined(<span class="variable">$info</span>);</span><br><span class="line">    next <span class="keyword">if</span> ( <span class="variable">$my_connection_id</span> == <span class="variable">$id</span> );</span><br><span class="line">    next <span class="keyword">if</span> ( defined(<span class="variable">$query_time</span>) &amp;&amp; <span class="variable">$query_time</span> &lt; <span class="variable">$running_time_threshold</span> );</span><br><span class="line">    next <span class="keyword">if</span> ( defined(<span class="variable">$command</span>)    &amp;&amp; <span class="variable">$command</span> eq <span class="string">"Binlog Dump"</span> );</span><br><span class="line">    next <span class="keyword">if</span> ( defined(<span class="variable">$user</span>)       &amp;&amp; <span class="variable">$user</span> eq <span class="string">"system user"</span> );</span><br><span class="line">    next</span><br><span class="line">      <span class="keyword">if</span> ( defined(<span class="variable">$command</span>)</span><br><span class="line">      &amp;&amp; <span class="variable">$command</span> eq <span class="string">"Sleep"</span></span><br><span class="line">      &amp;&amp; defined(<span class="variable">$query_time</span>)</span><br><span class="line">      &amp;&amp; <span class="variable">$query_time</span> &gt;= 1 );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( <span class="variable">$type</span> &gt;= 1 ) &#123;</span><br><span class="line">      next <span class="keyword">if</span> ( defined(<span class="variable">$command</span>) &amp;&amp; <span class="variable">$command</span> eq <span class="string">"Sleep"</span> );</span><br><span class="line">      next <span class="keyword">if</span> ( defined(<span class="variable">$command</span>) &amp;&amp; <span class="variable">$command</span> eq <span class="string">"Connect"</span> );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( <span class="variable">$type</span> &gt;= 2 ) &#123;</span><br><span class="line">      next <span class="keyword">if</span> ( defined(<span class="variable">$info</span>) &amp;&amp; <span class="variable">$info</span> =~ m/^select/i );</span><br><span class="line">      next <span class="keyword">if</span> ( defined(<span class="variable">$info</span>) &amp;&amp; <span class="variable">$info</span> =~ m/^show/i );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    push @threads, <span class="variable">$ref</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">return</span> @threads;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">sub main &#123;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="variable">$command</span> eq <span class="string">"stop"</span> ) &#123;</span><br><span class="line">    <span class="comment">## Gracefully killing connections on the current master</span></span><br><span class="line">    <span class="comment"># 1. Set read_only= 1 on the new master</span></span><br><span class="line">    <span class="comment"># 2. DROP USER so that no app user can establish new connections</span></span><br><span class="line">    <span class="comment"># 3. Set read_only= 1 on the current master</span></span><br><span class="line">    <span class="comment"># 4. Kill current queries</span></span><br><span class="line">    <span class="comment"># * Any database access failure will result in script die.</span></span><br><span class="line">    my <span class="variable">$exit_code</span> = 1;</span><br><span class="line">    <span class="built_in">eval</span> &#123;</span><br><span class="line">      <span class="comment">## Setting read_only=1 on the new master (to avoid accident)</span></span><br><span class="line">      my <span class="variable">$new_master_handler</span> = new MHA::DBHelper();</span><br><span class="line"></span><br><span class="line">      <span class="comment"># args: hostname, port, user, password, raise_error(die_on_error)_or_not</span></span><br><span class="line">      <span class="variable">$new_master_handler</span>-&gt;connect( <span class="variable">$new_master_ip</span>, <span class="variable">$new_master_port</span>,</span><br><span class="line">        <span class="variable">$new_master_user</span>, <span class="variable">$new_master_password</span>, 1 );</span><br><span class="line">      <span class="built_in">print</span> current_time_us() . <span class="string">" Set read_only on the new master.. "</span>;</span><br><span class="line">      <span class="variable">$new_master_handler</span>-&gt;enable_read_only();</span><br><span class="line">      <span class="keyword">if</span> ( <span class="variable">$new_master_handler</span>-&gt;is_read_only() ) &#123;</span><br><span class="line">        <span class="built_in">print</span> <span class="string">"ok.\n"</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">        die <span class="string">"Failed!\n"</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="variable">$new_master_handler</span>-&gt;disconnect();</span><br><span class="line"></span><br><span class="line">      <span class="comment"># Connecting to the orig master, die if any database error happens</span></span><br><span class="line">      my <span class="variable">$orig_master_handler</span> = new MHA::DBHelper();</span><br><span class="line">      <span class="variable">$orig_master_handler</span>-&gt;connect( <span class="variable">$orig_master_ip</span>, <span class="variable">$orig_master_port</span>,</span><br><span class="line">        <span class="variable">$orig_master_user</span>, <span class="variable">$orig_master_password</span>, 1 );</span><br><span class="line"></span><br><span class="line">      <span class="comment">## Drop application user so that nobody can connect. Disabling per-session binlog beforehand</span></span><br><span class="line">      <span class="comment">#$orig_master_handler-&gt;disable_log_bin_local();</span></span><br><span class="line">      <span class="comment">#print current_time_us() . " Drpping app user on the orig master..\n";</span></span><br><span class="line">      <span class="comment">#FIXME_xxx_drop_app_user($orig_master_handler);</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">## Waiting for N * 100 milliseconds so that current connections can exit</span></span><br><span class="line">      my <span class="variable">$time_until_read_only</span> = 15;</span><br><span class="line">      <span class="variable">$_tstart</span> = [gettimeofday];</span><br><span class="line">      my @threads = get_threads_util( <span class="variable">$orig_master_handler</span>-&gt;&#123;dbh&#125;,</span><br><span class="line">        <span class="variable">$orig_master_handler</span>-&gt;&#123;connection_id&#125; );</span><br><span class="line">      <span class="keyword">while</span> ( <span class="variable">$time_until_read_only</span> &gt; 0 &amp;&amp; <span class="variable">$#threads</span> &gt;= 0 ) &#123;</span><br><span class="line">        <span class="keyword">if</span> ( <span class="variable">$time_until_read_only</span> % 5 == 0 ) &#123;</span><br><span class="line">          <span class="built_in">printf</span></span><br><span class="line"><span class="string">"%s Waiting all running %d threads are disconnected.. (max %d milliseconds)\n"</span>,</span><br><span class="line">            current_time_us(), <span class="variable">$#threads</span> + 1, <span class="variable">$time_until_read_only</span> * 100;</span><br><span class="line">          <span class="keyword">if</span> ( <span class="variable">$#threads</span> &lt; 5 ) &#123;</span><br><span class="line">            <span class="built_in">print</span> Data::Dumper-&gt;new( [<span class="variable">$_</span>] )-&gt;Indent(0)-&gt;Terse(1)-&gt;Dump . <span class="string">"\n"</span></span><br><span class="line">              foreach (@threads);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        sleep_until();</span><br><span class="line">        <span class="variable">$_tstart</span> = [gettimeofday];</span><br><span class="line">        <span class="variable">$time_until_read_only</span>--;</span><br><span class="line">        @threads = get_threads_util( <span class="variable">$orig_master_handler</span>-&gt;&#123;dbh&#125;,</span><br><span class="line">          <span class="variable">$orig_master_handler</span>-&gt;&#123;connection_id&#125; );</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">## Setting read_only=1 on the current master so that nobody(except SUPER) can write</span></span><br><span class="line">      <span class="built_in">print</span> current_time_us() . <span class="string">" Set read_only=1 on the orig master.. "</span>;</span><br><span class="line">      <span class="variable">$orig_master_handler</span>-&gt;enable_read_only();</span><br><span class="line">      <span class="keyword">if</span> ( <span class="variable">$orig_master_handler</span>-&gt;is_read_only() ) &#123;</span><br><span class="line">        <span class="built_in">print</span> <span class="string">"ok.\n"</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;</span><br><span class="line">        die <span class="string">"Failed!\n"</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">## Waiting for M * 100 milliseconds so that current update queries can complete</span></span><br><span class="line">      my <span class="variable">$time_until_kill_threads</span> = 5;</span><br><span class="line">      @threads = get_threads_util( <span class="variable">$orig_master_handler</span>-&gt;&#123;dbh&#125;,</span><br><span class="line">        <span class="variable">$orig_master_handler</span>-&gt;&#123;connection_id&#125; );</span><br><span class="line">      <span class="keyword">while</span> ( <span class="variable">$time_until_kill_threads</span> &gt; 0 &amp;&amp; <span class="variable">$#threads</span> &gt;= 0 ) &#123;</span><br><span class="line">        <span class="keyword">if</span> ( <span class="variable">$time_until_kill_threads</span> % 5 == 0 ) &#123;</span><br><span class="line">          <span class="built_in">printf</span></span><br><span class="line"><span class="string">"%s Waiting all running %d queries are disconnected.. (max %d milliseconds)\n"</span>,</span><br><span class="line">            current_time_us(), <span class="variable">$#threads</span> + 1, <span class="variable">$time_until_kill_threads</span> * 100;</span><br><span class="line">          <span class="keyword">if</span> ( <span class="variable">$#threads</span> &lt; 5 ) &#123;</span><br><span class="line">            <span class="built_in">print</span> Data::Dumper-&gt;new( [<span class="variable">$_</span>] )-&gt;Indent(0)-&gt;Terse(1)-&gt;Dump . <span class="string">"\n"</span></span><br><span class="line">              foreach (@threads);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        sleep_until();</span><br><span class="line">        <span class="variable">$_tstart</span> = [gettimeofday];</span><br><span class="line">        <span class="variable">$time_until_kill_threads</span>--;</span><br><span class="line">        @threads = get_threads_util( <span class="variable">$orig_master_handler</span>-&gt;&#123;dbh&#125;,</span><br><span class="line">          <span class="variable">$orig_master_handler</span>-&gt;&#123;connection_id&#125; );</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                <span class="built_in">print</span> <span class="string">"Disabling the VIP on old master: <span class="variable">$orig_master_host</span> \n"</span>;</span><br><span class="line">                &amp;stop_vip();     </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      <span class="comment">## Terminating all threads</span></span><br><span class="line">      <span class="built_in">print</span> current_time_us() . <span class="string">" Killing all application threads..\n"</span>;</span><br><span class="line">      <span class="variable">$orig_master_handler</span>-&gt;kill_threads(@threads) <span class="keyword">if</span> ( <span class="variable">$#threads</span> &gt;= 0 );</span><br><span class="line">      <span class="built_in">print</span> current_time_us() . <span class="string">" done.\n"</span>;</span><br><span class="line">      <span class="comment">#$orig_master_handler-&gt;enable_log_bin_local();</span></span><br><span class="line">      <span class="variable">$orig_master_handler</span>-&gt;disconnect();</span><br><span class="line"></span><br><span class="line">      <span class="comment">## After finishing the script, MHA executes FLUSH TABLES WITH READ LOCK</span></span><br><span class="line">      <span class="variable">$exit_code</span> = 0;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$@</span>) &#123;</span><br><span class="line">      warn <span class="string">"Got Error: <span class="variable">$@</span>\n"</span>;</span><br><span class="line">      <span class="built_in">exit</span> <span class="variable">$exit_code</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">exit</span> <span class="variable">$exit_code</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  elsif ( <span class="variable">$command</span> eq <span class="string">"start"</span> ) &#123;</span><br><span class="line">    <span class="comment">## Activating master ip on the new master</span></span><br><span class="line">    <span class="comment"># 1. Create app user with write privileges</span></span><br><span class="line">    <span class="comment"># 2. Moving backup script if needed</span></span><br><span class="line">    <span class="comment"># 3. Register new master's ip to the catalog database</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># We don't return error even though activating updatable accounts/ip failed so that we don't interrupt slaves' recovery.</span></span><br><span class="line"><span class="comment"># If exit code is 0 or 10, MHA does not abort</span></span><br><span class="line">    my <span class="variable">$exit_code</span> = 10;</span><br><span class="line">    <span class="built_in">eval</span> &#123;</span><br><span class="line">      my <span class="variable">$new_master_handler</span> = new MHA::DBHelper();</span><br><span class="line"></span><br><span class="line">      <span class="comment"># args: hostname, port, user, password, raise_error_or_not</span></span><br><span class="line">      <span class="variable">$new_master_handler</span>-&gt;connect( <span class="variable">$new_master_ip</span>, <span class="variable">$new_master_port</span>,</span><br><span class="line">        <span class="variable">$new_master_user</span>, <span class="variable">$new_master_password</span>, 1 );</span><br><span class="line"></span><br><span class="line">      <span class="comment">## Set read_only=0 on the new master</span></span><br><span class="line">      <span class="comment">#$new_master_handler-&gt;disable_log_bin_local();</span></span><br><span class="line">      <span class="built_in">print</span> current_time_us() . <span class="string">" Set read_only=0 on the new master.\n"</span>;</span><br><span class="line">      <span class="variable">$new_master_handler</span>-&gt;disable_read_only();</span><br><span class="line"></span><br><span class="line">      <span class="comment">## Creating an app user on the new master</span></span><br><span class="line">      <span class="comment">#print current_time_us() . " Creating app user on the new master..\n";</span></span><br><span class="line">      <span class="comment">#FIXME_xxx_create_app_user($new_master_handler);</span></span><br><span class="line">      <span class="comment">#$new_master_handler-&gt;enable_log_bin_local();</span></span><br><span class="line">      <span class="variable">$new_master_handler</span>-&gt;disconnect();</span><br><span class="line"></span><br><span class="line">      <span class="comment">## Update master ip on the catalog database, etc</span></span><br><span class="line">                <span class="built_in">print</span> <span class="string">"Enabling the VIP - <span class="variable">$vip</span> on the new master - <span class="variable">$new_master_host</span> \n"</span>;</span><br><span class="line">                &amp;start_vip();</span><br><span class="line">                <span class="variable">$exit_code</span> = 0;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$@</span>) &#123;</span><br><span class="line">      warn <span class="string">"Got Error: <span class="variable">$@</span>\n"</span>;</span><br><span class="line">      <span class="built_in">exit</span> <span class="variable">$exit_code</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">exit</span> <span class="variable">$exit_code</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  elsif ( <span class="variable">$command</span> eq <span class="string">"status"</span> ) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># do nothing</span></span><br><span class="line">    <span class="built_in">exit</span> 0;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    &amp;usage();</span><br><span class="line">    <span class="built_in">exit</span> 1;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># A simple system call that enable the VIP on the new master </span></span><br><span class="line">sub <span class="function"><span class="title">start_vip</span></span>() &#123;</span><br><span class="line">    `ssh <span class="variable">$ssh_user</span>\@<span class="variable">$new_master_host</span> \<span class="string">" <span class="variable">$ssh_start_vip</span> \"`;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"># A simple system call that disable the VIP on the old_master</span></span><br><span class="line"><span class="string">sub stop_vip() &#123;</span></span><br><span class="line"><span class="string">    `ssh <span class="variable">$ssh_user</span>\@<span class="variable">$orig_master_host</span> \" <span class="variable">$ssh_stop_vip</span> \"`;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">sub usage &#123;</span></span><br><span class="line"><span class="string">  print</span></span><br><span class="line"><span class="string">"</span>Usage: master_ip_online_change --<span class="built_in">command</span>=start|stop|status --orig_master_host=host --orig_master_ip=ip --orig_master_port=port --new_master_host=host --new_master_ip=ip --new_master_port=port\n<span class="string">";</span></span><br><span class="line"><span class="string">  die;</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure></p></blockquote><blockquote><p>/usr/local/bin/send_report 切换时发送邮件 注：发送邮件需要这台服务器能够连接互联网<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/perl</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  Copyright (C) 2011 DeNA Co.,Ltd.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#  This program is free software; you can redistribute it and/or modify</span></span><br><span class="line"><span class="comment">#  it under the terms of the GNU General Public License as published by</span></span><br><span class="line"><span class="comment">#  the Free Software Foundation; either version 2 of the License, or</span></span><br><span class="line"><span class="comment">#  (at your option) any later version.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#  This program is distributed in the hope that it will be useful,</span></span><br><span class="line"><span class="comment">#  but WITHOUT ANY WARRANTY; without even the implied warranty of</span></span><br><span class="line"><span class="comment">#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span></span><br><span class="line"><span class="comment">#  GNU General Public License for more details.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#  You should have received a copy of the GNU General Public License</span></span><br><span class="line"><span class="comment">#   along with this program; if not, write to the Free Software</span></span><br><span class="line"><span class="comment">#  Foundation, Inc.,</span></span><br><span class="line"><span class="comment">#  51 Franklin Street, Fifth Floor, Boston, MA  02110-1301  USA</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## <span class="doctag">Note:</span> This is a sample script and is not complete. Modify the script based on your environment.</span></span><br><span class="line"></span><br><span class="line">use strict;</span><br><span class="line">use warnings FATAL =&gt; <span class="string">'all'</span>;</span><br><span class="line">use Mail::Sender;</span><br><span class="line">use Getopt::Long;</span><br><span class="line"></span><br><span class="line"><span class="comment">#new_master_host and new_slave_hosts are set only when recovering master succeeded</span></span><br><span class="line">my ( <span class="variable">$dead_master_host</span>, <span class="variable">$new_master_host</span>, <span class="variable">$new_slave_hosts</span>, <span class="variable">$subject</span>, <span class="variable">$body</span> );</span><br><span class="line">my <span class="variable">$smtp</span>=<span class="string">'smtp.139.com'</span>;</span><br><span class="line">my <span class="variable">$mail_from</span>=<span class="string">'########@139.com'</span>;</span><br><span class="line">my <span class="variable">$mail_user</span>=<span class="string">'########@139.com'</span>;</span><br><span class="line">my <span class="variable">$mail_pass</span>=<span class="string">'########;</span></span><br><span class="line"><span class="string">my $mail_to=['</span><span class="comment">########@139.com','########@baidu.com.cn'];</span></span><br><span class="line">GetOptions(</span><br><span class="line">  <span class="string">'orig_master_host=s'</span> =&gt; \<span class="variable">$dead_master_host</span>,</span><br><span class="line">  <span class="string">'new_master_host=s'</span>  =&gt; \<span class="variable">$new_master_host</span>,</span><br><span class="line">  <span class="string">'new_slave_hosts=s'</span>  =&gt; \<span class="variable">$new_slave_hosts</span>,</span><br><span class="line">  <span class="string">'subject=s'</span>          =&gt; \<span class="variable">$subject</span>,</span><br><span class="line">  <span class="string">'body=s'</span>             =&gt; \<span class="variable">$body</span>,</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">mailToContacts(<span class="variable">$smtp</span>,<span class="variable">$mail_from</span>,<span class="variable">$mail_user</span>,<span class="variable">$mail_pass</span>,<span class="variable">$mail_to</span>,<span class="variable">$subject</span>,<span class="variable">$body</span>);</span><br><span class="line"></span><br><span class="line">sub mailToContacts &#123;</span><br><span class="line">    my ( <span class="variable">$smtp</span>, <span class="variable">$mail_from</span>, <span class="variable">$user</span>, <span class="variable">$passwd</span>, <span class="variable">$mail_to</span>, <span class="variable">$subject</span>, <span class="variable">$msg</span> ) = @_;</span><br><span class="line">    open my <span class="variable">$DEBUG</span>, <span class="string">"&gt; /tmp/monitormail.log"</span></span><br><span class="line">        or die <span class="string">"Can't open the debug      file:$!\n"</span>;</span><br><span class="line">    my <span class="variable">$sender</span> = new Mail::Sender &#123;</span><br><span class="line">        ctype       =&gt; <span class="string">'text/plain; charset=utf-8'</span>,</span><br><span class="line">        encoding    =&gt; <span class="string">'utf-8'</span>,</span><br><span class="line">        smtp        =&gt; <span class="variable">$smtp</span>,</span><br><span class="line">        from        =&gt; <span class="variable">$mail_from</span>,</span><br><span class="line">        auth        =&gt; <span class="string">'LOGIN'</span>,</span><br><span class="line">        TLS_allowed =&gt; <span class="string">'0'</span>,</span><br><span class="line">        authid      =&gt; <span class="variable">$user</span>,</span><br><span class="line">        authpwd     =&gt; <span class="variable">$passwd</span>,</span><br><span class="line">        to          =&gt; <span class="variable">$mail_to</span>,</span><br><span class="line">        subject     =&gt; <span class="variable">$subject</span>,</span><br><span class="line">        debug       =&gt; <span class="variable">$DEBUG</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$sender</span>-&gt;MailMsg(</span><br><span class="line">        &#123;   msg   =&gt; <span class="variable">$msg</span>,</span><br><span class="line">            debug =&gt; <span class="variable">$DEBUG</span></span><br><span class="line">        &#125;</span><br><span class="line">    ) or <span class="built_in">print</span> <span class="variable">$Mail</span>::Sender::Error;</span><br><span class="line">    <span class="built_in">return</span> 1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Do whatever you want here</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">exit</span> 0;</span><br></pre></td></tr></table></figure></p></blockquote><h4 id="3-3-2-4-每台slave设置定时清除relay日志脚本"><a href="#3-3-2-4-每台slave设置定时清除relay日志脚本" class="headerlink" title="3.3.2.4 每台slave设置定时清除relay日志脚本"></a>3.3.2.4 每台slave设置定时清除relay日志脚本</h4><blockquote><p>MHA在发生切换的过程中，从库的恢复过程中依赖于relay log的相关信息，所以这里要将relay log的自动清除设置为OFF，采用手动清除relay log的方式。在默认情况下，从服务器上的中继日志会在SQL线程执行完毕后被自动删除。但是在MHA环境中，这些中继日志在恢复其他从服务器时可能会被用到，因此需要禁用中继日志的自动删除功能。定期清除中继日志需要考虑到复制延时的问题。在ext3的文件系统下，删除大的文件需要一定的时间，会导致严重的复制延时。为了避免复制延时，需要暂时为中继日志创建硬链接，因为在linux系统中通过硬链接删除大文件速度会很快。（在mysql数据库中，删除大表时，通常也采用建立硬链接的方式）<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment">#此脚本添加至定时任务，每天凌晨四点执行，定时任务示例如下：</span></span><br><span class="line"><span class="comment">#0 4 * * * /bin/bash /usr/local/bin/purge_relay_log.sh</span></span><br><span class="line">user=root</span><br><span class="line">passwd=mvtech123</span><br><span class="line">port=3306</span><br><span class="line">log_dir=<span class="string">'/var/log/masterha/'</span></span><br><span class="line"><span class="comment">#relay日志的目录</span></span><br><span class="line">work_dir=<span class="string">'/mvtech/mysql/logs/relay'</span></span><br><span class="line">purge=<span class="string">'/usr/bin/purge_relay_logs'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ ! -d <span class="variable">$log_dir</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">   mkdir <span class="variable">$log_dir</span> -p</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$purge</span> --user=<span class="variable">$user</span> --password=<span class="variable">$passwd</span> --disable_relay_log_purge --port=<span class="variable">$port</span> --workdir=<span class="variable">$work_dir</span> &gt;&gt; <span class="variable">$log_dir</span>/purge_relay_logs.log 2&gt;&amp;1</span><br></pre></td></tr></table></figure></p></blockquote><h4 id="3-3-2-4-验证集群配置情况"><a href="#3-3-2-4-验证集群配置情况" class="headerlink" title="3.3.2.4 验证集群配置情况"></a>3.3.2.4 验证集群配置情况</h4><blockquote><p>验证ssh互信：masterha_check_ssh –conf=/etc/masterha/app1.conf </p></blockquote><center><img src="https://i.loli.net/2018/11/23/5bf791b401f91.png" alt="ssh检查.png" title="ssh检查.png"></center><blockquote><p>验证复制状态：masterha_check_repl –conf=/etc/masterha/app1.conf</p></blockquote><center><img src="https://i.loli.net/2018/11/23/5bf791b41b9dd.png" alt="repl检查.png" title="repl检查.png"></center><blockquote><p>验证集群状态：masterha_check_status –conf=/etc/masterha/app1.conf</p></blockquote><center><img src="https://i.loli.net/2018/11/23/5bf791b3727dd.png" alt="检查manager状态.png" title="检查manager状态.png"></center><h4 id="3-3-2-5-启动manager服务"><a href="#3-3-2-5-启动manager服务" class="headerlink" title="3.3.2.5 启动manager服务"></a>3.3.2.5 启动manager服务</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nohup masterha_manager --conf=/etc/masterha/app1.conf --ignore_last_failover &lt; /dev/null &gt; /var/<span class="built_in">log</span>/masterha/app1/manager.log 2&gt;&amp;1 &amp;</span><br></pre></td></tr></table></figure><blockquote><p>集群可用状态</p></blockquote><center><img src="https://i.loli.net/2018/11/23/5bf791b40135f.png" alt="状态ok.png" title="状态ok.png"></center><h1 id="4-模拟故障，验证集群的可用性"><a href="#4-模拟故障，验证集群的可用性" class="headerlink" title="4 模拟故障，验证集群的可用性"></a>4 模拟故障，验证集群的可用性</h1><h2 id="4-1-失败自动切换-模拟master主机msyql挂掉，并恢复集群"><a href="#4-1-失败自动切换-模拟master主机msyql挂掉，并恢复集群" class="headerlink" title="4.1 失败自动切换 模拟master主机msyql挂掉，并恢复集群"></a>4.1 失败自动切换 模拟master主机msyql挂掉，并恢复集群</h2><h3 id="4-1-1-关闭master主机"><a href="#4-1-1-关闭master主机" class="headerlink" title="4.1.1 关闭master主机"></a>4.1.1 关闭master主机</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop mysqld</span><br></pre></td></tr></table></figure><h3 id="4-1-2-查看manage日志"><a href="#4-1-2-查看manage日志" class="headerlink" title="4.1.2 查看manage日志"></a>4.1.2 查看manage日志</h3><blockquote><p>tail -f /var/log/masterha/app1/manager.log </p></blockquote><blockquote><p>通过查看日志，会看到自动切换的过程，并发送邮件</p></blockquote><h3 id="4-1-3-检查备用master是否提升为主节点"><a href="#4-1-3-检查备用master是否提升为主节点" class="headerlink" title="4.1.3 检查备用master是否提升为主节点"></a>4.1.3 检查备用master是否提升为主节点</h3><blockquote><p>检查vip是否漂在node72节点上<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ip addr</span><br></pre></td></tr></table></figure></p></blockquote><blockquote><p>查看目前node72上是否还属于node73的slave节点<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">slave</span> <span class="keyword">status</span>\G</span><br><span class="line"><span class="comment"># 经检查 已不是slave节点</span></span><br></pre></td></tr></table></figure></p></blockquote><h3 id="4-1-4-检查独立slave主机的主从复制状态"><a href="#4-1-4-检查独立slave主机的主从复制状态" class="headerlink" title="4.1.4 检查独立slave主机的主从复制状态"></a>4.1.4 检查独立slave主机的主从复制状态</h3><blockquote><p>通过检查复制状态，发现现在node01节点的master节点变为node72<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show slave status\G</span><br></pre></td></tr></table></figure></p></blockquote><h3 id="4-1-5-恢复集群"><a href="#4-1-5-恢复集群" class="headerlink" title="4.1.5 恢复集群"></a>4.1.5 恢复集群</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">1.通过备份工具将node72上数据同步至node73节点上，并以node02作为master节点配置node03位slave节点；</span><br><span class="line">2.在node03节点上执行sql：</span><br><span class="line">    <span class="built_in">set</span> global relay_log_purge=0;</span><br><span class="line">    <span class="built_in">set</span> global read_only=1;</span><br><span class="line">3.修改node01上集群的配置文件/etc/masterha/app1.conf，将原来node03作为master的配置改为node02</span><br><span class="line">4.使用集群验证脚本验证ssh互信、复制状态等是否ok</span><br><span class="line">5.启动manager继续监控集群</span><br><span class="line">6.至此，集群恢复完毕</span><br></pre></td></tr></table></figure><h2 id="4-2-在线切换master"><a href="#4-2-在线切换master" class="headerlink" title="4.2 在线切换master"></a>4.2 在线切换master</h2><blockquote><p> 在许多情况下， 需要将现有的主服务器迁移到另外一台服务器上。 比如主服务器硬件故障，RAID 控制卡需要重建，将主服务器移到性能更好的服务器上等等。维护主服务器引起性能下降， 导致停机时间至少无法写入数据。 另外， 阻塞或杀掉当前运行的会话会导致主主之间数据不一致的问题发生。 MHA 提供快速切换和优雅的阻塞写入，这个切换过程只需要 0.5-2s 的时间，这段时间内数据是无法写入的。在很多情况下，0.5-2s 的阻塞写入是可以接受的。因此切换主服务器不需要计划分配维护时间窗口。</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">1.停止mha集群监控</span><br><span class="line">    masterha_stop --conf=/etc/masterha/app1.conf</span><br><span class="line">2.执行切换命令</span><br><span class="line">    masterha_master_switch --conf=/etc/masterha/app1.conf --master_state=alive --new_master_host=node72 --new_master_port=3306 --orig_master_is_new_slave --running_updates_limit=10000 --interactive=0</span><br><span class="line">3.验证node72是否变成master节点</span><br><span class="line"></span><br><span class="line"><span class="comment">#从72切到73</span></span><br><span class="line">masterha_master_switch --conf=/etc/masterha/app1.conf_node72 --master_state=alive --new_master_host=node73 --new_master_port=3306 --orig_master_is_new_slave --running_updates_limit=10000 --interactive=0</span><br><span class="line"><span class="comment">#从73切到72</span></span><br><span class="line">masterha_master_switch --conf=/etc/masterha/app1.conf --master_state=alive --new_master_host=node72 --new_master_port=3306 --orig_master_is_new_slave --running_updates_limit=10000 --interactive=0</span><br></pre></td></tr></table></figure><h2 id="4-3-失败手工切换"><a href="#4-3-失败手工切换" class="headerlink" title="4.3 失败手工切换"></a>4.3 失败手工切换</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">masterha_master_switch --master_state=dead --conf=/etc/masterha/app1.conf --dead_master_host=node73 --dead_master_port=3306 --new_master_host=node72 --new_master_port=3306 --ignore_last_failover --interactive=0</span><br><span class="line">``` </span><br><span class="line"></span><br><span class="line"><span class="comment"># 5 维护mha集群</span></span><br><span class="line"><span class="comment">## 5.1 停止集群</span></span><br><span class="line"><span class="comment">### 5.1.1 关闭mha-manager监控脚本</span></span><br><span class="line">``` bash</span><br><span class="line">masterha_stop --conf=/etc/masterha/app1.conf</span><br></pre></td></tr></table></figure><h3 id="5-1-2-关闭master节点上的虚地址"><a href="#5-1-2-关闭master节点上的虚地址" class="headerlink" title="5.1.2 关闭master节点上的虚地址"></a>5.1.2 关闭master节点上的虚地址</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/sbin/ifconfig ens3:1 down</span><br><span class="line">``` </span><br><span class="line"><span class="comment">### 5.1.3 关闭master节点上的mysql</span></span><br><span class="line">``` bash</span><br><span class="line">systemctl stop mysqld</span><br></pre></td></tr></table></figure><h3 id="5-1-4-关闭两台slave节点上的mysql"><a href="#5-1-4-关闭两台slave节点上的mysql" class="headerlink" title="5.1.4 关闭两台slave节点上的mysql"></a>5.1.4 关闭两台slave节点上的mysql</h3><blockquote><p>分别在两台slave上执行<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop mysqld</span><br></pre></td></tr></table></figure></p></blockquote><h3 id="至此，mha集群关闭结束"><a href="#至此，mha集群关闭结束" class="headerlink" title="至此，mha集群关闭结束"></a>至此，mha集群关闭结束</h3><h2 id="5-2-启动集群"><a href="#5-2-启动集群" class="headerlink" title="5.2 启动集群"></a>5.2 启动集群</h2><h3 id="5-2-1-启动两台slave上的mysql，两台备库设置"><a href="#5-2-1-启动两台slave上的mysql，两台备库设置" class="headerlink" title="5.2.1 启动两台slave上的mysql，两台备库设置"></a>5.2.1 启动两台slave上的mysql，两台备库设置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemct start mysqld</span><br><span class="line"><span class="built_in">set</span> global relay_log_purge=0;</span><br><span class="line"><span class="built_in">set</span> global read_only=1;</span><br></pre></td></tr></table></figure><h3 id="5-2-2-启动master上的mysql"><a href="#5-2-2-启动master上的mysql" class="headerlink" title="5.2.2 启动master上的mysql"></a>5.2.2 启动master上的mysql</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemct start mysqld</span><br></pre></td></tr></table></figure><h3 id="5-2-3-启动master上的vip"><a href="#5-2-3-启动master上的vip" class="headerlink" title="5.2.3 启动master上的vip"></a>5.2.3 启动master上的vip</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/sbin/ifconfig ens3:1 192.168.2.74/24</span><br><span class="line">注：若使用keepalived则使用systemctl start keepalived</span><br></pre></td></tr></table></figure><h3 id="5-2-4-使用mha脚本监测集群状态："><a href="#5-2-4-使用mha脚本监测集群状态：" class="headerlink" title="5.2.4 使用mha脚本监测集群状态："></a>5.2.4 使用mha脚本监测集群状态：</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">masterha_check_ssh --conf=/etc/masterha/app1.conf </span><br><span class="line">masterha_check_repl --conf=/etc/masterha/app1.conf</span><br><span class="line">masterha_check_status --conf=/etc/masterha/app1.conf</span><br></pre></td></tr></table></figure><h3 id="5-2-5-若没有问题，则启动manager进行监控集群"><a href="#5-2-5-若没有问题，则启动manager进行监控集群" class="headerlink" title="5.2.5 若没有问题，则启动manager进行监控集群"></a>5.2.5 若没有问题，则启动manager进行监控集群</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nohup masterha_manager --conf=/etc/masterha/app1.conf --remove_dead_master_conf --ignore_last_failover &lt; /dev/null &gt; /var/<span class="built_in">log</span>/masterha/app1/manager.log 2&gt;&amp;1 &amp;</span><br></pre></td></tr></table></figure><blockquote><p>检查集群状态<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">masterha_check_status --conf=/etc/masterha/app1.conf</span><br></pre></td></tr></table></figure></p></blockquote><h3 id="至此集群启动完毕"><a href="#至此集群启动完毕" class="headerlink" title="至此集群启动完毕"></a>至此集群启动完毕</h3>]]></content>
      
      
      
        <tags>
            
            <tag> mysql </tag>
            
            <tag> 高可用架构 </tag>
            
        </tags>
      
    </entry>
    
  
  
</search>
